<!doctype html><html lang="en">
 <head>
  <meta charset="utf-8">
  <title>The Storage Access API</title>
  <meta content="width=device-width" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version b25686b9f, updated Fri Mar 14 14:15:20 2025 -0700" name="generator">
  <link href="https://privacycg.github.io/storage-access/" rel="canonical">
  <link href="https://www.w3.org/2008/site/images/favicon.ico" rel="icon">
  <meta content="b569d1e224927140624d2ac0626cac09f6a01772" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>
.XXX {
    color: #E50000;
    font-weight: bold;
}
.XXX::before {
    content: "TODO: ";
}
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body>
  <header>
   <h1 class="no-ref" id="title">The Storage Access API</h1>
   <h2 class="no-num no-toc no-ref heading settled" id="subtitle"><span class="content">Draft Community Group Report, <time datetime="2025-04-12">12 April 2025</time></span></h2>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://privacycg.github.io/storage-access/">https://privacycg.github.io/storage-access/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/privacycg/storage-access/issues/">GitHub</a>
     <dd><a href="#issues-index">Inline In Spec</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard" data-editor-id="135256"><a class="p-name fn u-email email" href="mailto:bvandersloot@mozilla.com">Benjamin VanderSloot</a> (<a class="p-org org" href="https://mozilla.org">Mozilla</a>)
     <dd class="editor p-author h-card vcard" data-editor-id="120436"><a class="p-name fn u-email email" href="mailto:johannhof@google.com">Johann Hofmann</a> (<a class="p-org org" href="https://google.com">Google</a>)
     <dd class="editor p-author h-card vcard" data-editor-id="38001"><a class="p-name fn u-email email" href="mailto:annevk@annevk.nl">Anne van Kesteren</a> (<a class="p-org org" href="https://apple.com">Apple Inc.</a>)
     <dt class="editor">Former Editors:
     <dd class="editor p-author h-card vcard" data-editor-id="89478"><a class="p-name fn u-email email" href="mailto:wilander@apple.com">John Wilander</a> (<a class="p-org org" href="https://apple.com">Apple Inc.</a>)
     <dd class="editor p-author h-card vcard" data-editor-id="40614"><a class="p-name fn u-email email" href="mailto:hober@apple.com">Theresa O’Connor</a> (<a class="p-org org" href="https://apple.com">Apple Inc.</a>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 the Contributors to “The Storage Access API”, published by the <a href="http://www.w3.org/community/privacycg/">Privacy Community Group</a>.

This document is licensed under the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.

Contributions to this document are made under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. </p>
   <hr title="Separator for header">
  </header>
  <div data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The Storage Access API enables content in iframes to request access to website data (such as cookies).</p>
  </div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p>This specification is intended to be merged into the HTML Living Standard. It is neither a WHATWG Living Standard nor is it on the standards track at W3C.</p>
   <p>It was published by the <a href="http://www.w3.org/community/privacycg/">Privacy Community Group</a>.
Please note that under the <a href="http://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.
Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
    <li><a href="#infra"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
    <li>
     <a href="#the-storage-access-api"><span class="secno">3</span> <span class="content">The Storage Access API</span></a>
     <ol class="toc">
      <li><a href="#ua-state"><span class="secno">3.1</span> <span class="content">Changes to user agent state related to storage access</span></a>
      <li><a href="#the-document-object"><span class="secno">3.2</span> <span class="content">Changes to <code class="idl"><span>Document</span></code></span></a>
      <li><a href="#navigation"><span class="secno">3.3</span> <span class="content">Changes to navigation</span></a>
      <li>
       <a href="#fetch-integration"><span class="secno">3.4</span> <span class="content">Integration with Fetch</span></a>
       <ol class="toc">
        <li><a href="#fetching"><span class="secno">3.4.1</span> <span class="content">Fetching</span></a>
        <li><a href="#http-redirect-fetch"><span class="secno">3.4.2</span> <span class="content">HTTP-redirect-fetch</span></a>
       </ol>
      <li>
       <a href="#storage"><span class="secno">3.5</span> <span class="content">Changes to various client-side storage mechanisms</span></a>
       <ol class="toc">
        <li><a href="#cookies"><span class="secno">3.5.1</span> <span class="content">Cookies</span></a>
       </ol>
      <li><a href="#sandboxing-storage-access"><span class="secno">3.6</span> <span class="content">Sandboxing storage access</span></a>
     </ol>
    <li><a href="#permissions-integration"><span class="secno">4</span> <span class="content">Permissions Integration</span></a>
    <li><a href="#permissions-policy-integration"><span class="secno">5</span> <span class="content">Permissions Policy Integration</span></a>
    <li>
     <a href="#privacy"><span class="secno">6</span> <span class="content">Privacy considerations</span></a>
     <ol class="toc">
      <li><a href="#site-scope"><span class="secno">6.1</span> <span class="content">Permission scope</span></a>
     </ol>
    <li>
     <a href="#security"><span class="secno">7</span> <span class="content">Security considerations</span></a>
     <ol class="toc">
      <li><a href="#reputation"><span class="secno">7.1</span> <span class="content">Reputational attacks</span></a>
      <li><a href="#notification"><span class="secno">7.2</span> <span class="content">Notification abuse</span></a>
     </ol>
    <li>
     <a href="#automation"><span class="secno">8</span> <span class="content">Automation</span></a>
     <ol class="toc">
      <li><a href="#set-storage-access-command"><span class="secno">8.1</span> <span class="content">Set Storage Access</span></a>
     </ol>
    <li><a href="#acknowledgements"><span class="secno"></span> <span class="content">Acknowledgements</span></a>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <section class="non-normative">
    <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
    <p><em>This section is non-normative.</em></p>
    <p>User Agents sometimes prevent content inside certain <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element">iframe</a></code>s from accessing data stored in client-side storage mechanisms like cookies. This can break embedded content which relies on having access to client-side storage.</p>
    <p>The Storage Access API enables content inside <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element①">iframe</a></code>s to request and be granted access to their client-side storage, so that embedded content which relies on having access to client-side storage can work in such User Agents. <a data-link-type="biblio" href="#biblio-storage-access-intro" title="Introducing Storage Access API">[STORAGE-ACCESS-INTRO]</a></p>
   </section>
   <h2 class="heading settled" data-level="2" id="infra"><span class="secno">2. </span><span class="content">Infrastructure</span><a class="self-link" href="#infra"></a></h2>
   <p>This specification depends on the Infra standard. <a data-link-type="biblio" href="#biblio-infra" title="Infra Standard">[INFRA]</a></p>
   <h2 class="heading settled" data-level="3" id="the-storage-access-api"><span class="secno">3. </span><span class="content">The Storage Access API</span><a class="self-link" href="#the-storage-access-api"></a></h2>
   <p>This specification defines a method to query whether or not a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> currently has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data">unpartitioned data</a> (<code class="idl"><a data-link-type="idl" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess">hasStorageAccess()</a></code>), and a method that can be used to request access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data①">unpartitioned data</a> (<code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess">requestStorageAccess()</a></code>).</p>
   <div class="example" id="example-a7805ce9">
    <a class="self-link" href="#example-a7805ce9"></a> 
    <p>Alex visits <code>https://social.example/</code>. The page sets a cookie. This cookie has been set in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context">first-party-site context</a>.</p>
    <p>Later on, Alex visits <code>https://video.example/</code>, which has an <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element②">iframe</a></code> on it which loads <code>https://social.example/heart-button</code>. In this case, the <code>social.example</code> <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①">Document</a></code> <var>doc</var> is in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context">third party context</a>, and the cookie set previously might or might not be visible from <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie" id="ref-for-dom-document-cookie">cookie</a></code>, depending on User Agent storage access policies.</p>
    <p>Script in the <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element③">iframe</a></code> can call <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess①">hasStorageAccess()</a></code> to determine if it has access to the cookie. If it does not have access, it can request access by calling <var>doc</var><code>.</code><code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess①">requestStorageAccess()</a></code>.</p>
   </div>
   <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="unpartitioned-data">Unpartitioned data</dfn> is client-side storage that would be available to a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site">site</a> were it loaded in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context①">first-party-site context</a>.</p>
   <p>A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②">Document</a></code> is in a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="first-party-site-context">first-party-site context</dfn> if it is the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document">active document</a> of a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context">top-level browsing context</a>. Otherwise, it is in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context②">first-party-site context</a> if it is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document①">active document</a> and the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin">origin</a> and <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin">top-level origin</a> of its <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object">relevant settings object</a> are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site">same site</a> with one another.</p>
   <p>A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document③">Document</a></code> is in a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="third-party-context">third party context</dfn> if it is not in a <a data-link-type="dfn" href="#first-party-site-context" id="ref-for-first-party-site-context③">first-party-site context</a>.</p>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access">determine whether the user agent explicitly allows unpartitioned cookie access</dfn>, given a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple">tuple</a> <var>tuple</var> consisting of two <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site①">sites</a>, run the following steps. This algorithm returns "<code>none</code>", "<code>allow</code>" or "<code>disallow</code>".</p>
   <p class="note" role="note"><span class="marker">Note:</span> A user agent’s settings might explicitly allow or disallow unpartitioned cookie access through per-site allow-lists, the user changing global browser settings, or similar custom overrides.</p>
   <ol>
    <li data-md>
     <p>If the user agent does not have explicit settings for unpartitioned cookie access for <var>tuple</var>, return "<code>none</code>".</p>
    <li data-md>
     <p>If the user agent’s settings explicitly allow unpartitioned cookie access for <var>tuple</var>, return "<code>allow</code>".</p>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert">Assert</a>: the user agent’s settings explicitly disallow unpartitioned cookie access for <var>tuple</var>.</p>
    <li data-md>
     <p>Return "<code>disallow</code>".</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-the-fedcm-site-connection-status">determine the FedCM site connection status</dfn> given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin">origin</a> <var>embedder</var> and <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin①">origin</a> <var>identityProvider</var>, run the following steps. This algorithm returns a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean">boolean</a>.</p>
   <ol>
    <li data-md>
     <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>item</var> of <a data-link-type="dfn" href="https://w3c-fedid.github.io/FedCM/#browser-connected-accounts-set" id="ref-for-browser-connected-accounts-set">connected accounts set</a>:</p>
     <ol>
      <li data-md>
       <p>Let (<var>rp</var>, <var>idp</var>, <var>account</var>) be <var>item</var>.</p>
      <li data-md>
       <p>If <var>rp</var> and <var>embedder</var> are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site①">same site</a>, and <var>idp</var> and <var>identityProvider</var> are <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site②">same site</a>, return true.</p>
     </ol>
    <li data-md>
     <p>Return false.</p>
   </ol>
   <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-the-effective-fedcm-connection-status">determine the effective FedCM connection status</dfn> given a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin②">origin</a> <var>embedder</var>, a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin③">origin</a> <var>identityProvider</var>, a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document④">Document</a></code> <var>doc</var>, run the following steps. This algorithm returns a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean①">boolean</a>.</p>
   <ol>
    <li data-md>
     <p>Let <var>policyStatus</var> be whether <var>doc</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use">allowed to use</a> "<code>identity-credentials-get</code>".</p>
    <li data-md>
     <p>If <var>policyStatus</var> is "Disabled", return false.</p>
    <li data-md>
     <p>Let <var>connected</var> be the result of <a data-link-type="dfn" href="#determine-the-fedcm-site-connection-status" id="ref-for-determine-the-fedcm-site-connection-status">determining the site connection status</a> given <var>embedder</var> and <var>identityProvider</var>.</p>
    <li data-md>
     <p>If <var>connected</var> is false, return false.</p>
    <li data-md>
     <p>Let <var>preventSilentAccess</var> be <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#user-agent" id="ref-for-user-agent">user agent</a>’s <a data-link-type="dfn" href="https://w3c.github.io/webappsec-credential-management/#concept-credential-store" id="ref-for-concept-credential-store">credential store</a>’s <a data-link-type="dfn" href="https://w3c.github.io/webappsec-credential-management/#origin-prevent-silent-access-flag" id="ref-for-origin-prevent-silent-access-flag">prevent silent access flag</a> for <var>embedder</var>.</p>
    <li data-md>
     <p>If <var>preventSilentAccess</var>, return false.</p>
    <li data-md>
     <p>Return true.</p>
   </ol>
   <h3 class="heading settled" data-level="3.1" id="ua-state"><span class="secno">3.1. </span><span class="content">Changes to user agent state related to storage access</span><a class="self-link" href="#ua-state"></a></h3>
   <p>Modify the definition of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#environment" id="ref-for-environment">environment</a> in the following manner:</p>
   <ol>
    <li data-md>
     <p>Add a new member called <dfn class="dfn-paneled" data-dfn-for="environment" data-dfn-type="dfn" data-noexport id="environment-has-storage-access">has storage access</dfn> of type <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean②">boolean</a>.</p>
   </ol>
   <p>Modify the definition of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params" id="ref-for-source-snapshot-params">source snapshot params</a> in the following manner:</p>
   <ol>
    <li data-md>
     <p>Add a new member called <dfn class="dfn-paneled" data-dfn-for="source snapshot params" data-dfn-type="dfn" data-noexport id="source-snapshot-params-has-storage-access">has storage access</dfn> of type <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean③">boolean</a>.</p>
    <li data-md>
     <p>Add a new member called <dfn class="dfn-paneled" data-dfn-for="source snapshot params" data-dfn-type="dfn" data-noexport id="source-snapshot-params-environment-id">environment id</dfn> of type opaque <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a>.</p>
   </ol>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="storage-access-eligibility">storage access eligibility</dfn> is one of "<dfn class="dfn-paneled" data-dfn-for="storage access eligibility" data-dfn-type="dfn" data-noexport id="storage-access-eligibility-unset">unset</dfn>", "<dfn class="dfn-paneled" data-dfn-for="storage access eligibility" data-dfn-type="dfn" data-noexport id="storage-access-eligibility-ineligible">ineligible</dfn>", or "<dfn class="dfn-paneled" data-dfn-for="storage access eligibility" data-dfn-type="dfn" data-noexport id="storage-access-eligibility-eligible">eligible</dfn>".</p>
   <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request">request</a> has a <a data-link-type="dfn" href="#storage-access-eligibility" id="ref-for-storage-access-eligibility">storage access eligibility</a> <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-eligible-for-storage-access">eligible for storage-access</dfn>. It is initially "<code><a data-link-type="dfn" href="#storage-access-eligibility-unset" id="ref-for-storage-access-eligibility-unset">unset</a></code>".</p>
   <p class="note" role="note"><span class="marker">Note:</span> a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①">request</a>’s <a data-link-type="dfn" href="#storage-access-eligibility" id="ref-for-storage-access-eligibility①">storage access eligibility</a> indicates whether previously-granted "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access"><code>storage-access</code></a>" permissions ought to be considered when evaluating which cookies to include on the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request②">request</a>. In particular, note that after <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess②">requestStorageAccess</a></code> has resolved and the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#environment" id="ref-for-environment①">environment</a>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access">has storage access</a> is set to true, not all of the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request③">request</a>s issued by that <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#environment" id="ref-for-environment②">environment</a> ought to carry unpartitioned cookies. <br> <br> For example, suppose the user is visiting a page on https://top.com which embeds an <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element" id="ref-for-the-iframe-element④">iframe</a></code> served from https://embed.com, and a script in that iframe has called <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess③">requestStorageAccess</a></code> and the promise resolved. If the iframe subsequently fetches a resource from https://3p.com, that request will not include cookies via the Storage Access API.</p>
   <div class="algorithm" data-algorithm="determine the initial storage-access eligibility">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="determine-the-initial-storage-access-eligibility">determine the initial storage-access eligibility</dfn>, given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request④">request</a> <var>request</var>, run the following steps: 
    <ol>
     <li data-md>
      <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a> is null, return "<code><a data-link-type="dfn" href="#storage-access-eligibility-unset" id="ref-for-storage-access-eligibility-unset①">unset</a></code>".</p>
     <li data-md>
      <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client①">client</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#TODO" id="ref-for-TODO">ancestry</a> is not "<code>cross-site</code>", return "<code><a data-link-type="dfn" href="#storage-access-eligibility-unset" id="ref-for-storage-access-eligibility-unset②">unset</a></code>"</p>
    </ol>
    <p class="issue" id="issue-ad55531e"><a class="self-link" href="#issue-ad55531e"></a> The concept of "ancestry" is being added to HTML in <a href="https://github.com/whatwg/html/pull/11133">https://github.com/whatwg/html/pull/11133</a></p>
    <ol>
     <li data-md>
      <p>If <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client②">client</a>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access①">has storage access</a> is false, return "<code><a data-link-type="dfn" href="#storage-access-eligibility-ineligible" id="ref-for-storage-access-eligibility-ineligible">ineligible</a></code>".</p>
     <li data-md>
      <p>If <var>request</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin">same origin</a> with <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url">url</a>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin①">origin</a>, return "<code><a data-link-type="dfn" href="#storage-access-eligibility-ineligible" id="ref-for-storage-access-eligibility-ineligible①">ineligible</a></code>".</p>
     <li data-md>
      <p>Let <var>allowed</var> be the result of running <a data-link-type="abstract-op" href="https://w3c.github.io/webappsec-permissions-policy/#should-request-be-allowed-to-use-feature" id="ref-for-should-request-be-allowed-to-use-feature">Should request be allowed to use feature?</a> given "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access①"><code>storage-access</code></a>" and <var>request</var>.</p>
     <li data-md>
      <p>If <var>allowed</var> is false, return "<code><a data-link-type="dfn" href="#storage-access-eligibility-ineligible" id="ref-for-storage-access-eligibility-ineligible②">ineligible</a></code>".</p>
     <li data-md>
      <p>Return "<code><a data-link-type="dfn" href="#storage-access-eligibility-eligible" id="ref-for-storage-access-eligibility-eligible">eligible</a></code>".</p>
    </ol>
   </div>
   <h3 class="heading settled" data-level="3.2" id="the-document-object"><span class="secno">3.2. </span><span class="content">Changes to <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑤">Document</a></code></span><a class="self-link" href="#the-document-object"></a></h3>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑥"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasstorageaccess" id="ref-for-dom-document-hasstorageaccess②"><c- g>hasStorageAccess</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise①"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess④"><c- g>requestStorageAccess</c-></a>();
};
</pre>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑦">Document</a></code> <var>doc</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-hasstorageaccess"><code>hasStorageAccess()</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise">a new promise</a>.</p>
    <li data-md>
     <p>If <var>doc</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active">fully active</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject">reject</a> <var>p</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin">origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve">resolve</a> <var>p</var> with false and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>global</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global">relevant global object</a>.</p>
    <li data-md>
     <p>If <var>global</var> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context">secure context</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve①">resolve</a> <var>p</var> with false and return <var>p</var>.</p>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin①">top-level origin</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object①">relevant settings object</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque①">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve②">resolve</a> <var>p</var> with false and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>browsingContext</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc">browsing context</a>.</p>
    <li data-md>
     <p>Let <var>topLevelSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site">obtaining a site</a> from the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin②">top-level origin</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object②">relevant settings object</a>.</p>
    <li data-md>
     <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site①">obtaining a site</a> from <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin①">origin</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>explicitSetting</var> be the result of <a data-link-type="dfn" href="#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access" id="ref-for-determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access">determining whether the user agent explicitly allows unpartitioned cookie access</a> with (<var>topLevelSite</var>, <var>embeddedSite</var>).</p>
      <li data-md>
       <p>Let <var>permissionState</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-getting-the-current-permission-state" id="ref-for-dfn-getting-the-current-permission-state">getting the current permission state</a> given "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access②"><code>storage-access</code></a>" and <var>global</var>.</p>
      <li data-md>
       <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source">networking task source</a> given <var>global</var> to:</p>
       <ol>
        <li data-md>
         <p>If <var>explicitSetting</var> is "<code>disallow</code>", <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve③">resolve</a> <var>p</var> with false.</p>
        <li data-md>
         <p>If <var>explicitSetting</var> is "<code>allow</code>", <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve④">resolve</a> <var>p</var> with true.</p>
        <li data-md>
         <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert①">Assert</a>: <var>explicitSetting</var> is "<code>none</code>".</p>
        <li data-md>
         <p>If <var>browsingContext</var> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context①">top-level browsing context</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑤">resolve</a> <var>p</var> with true.</p>
        <li data-md>
         <p>If <var>browsingContext</var> is same authority with <var>browsingContext</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context②">top-level browsing context</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document②">active document</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑥">resolve</a> <var>p</var> with true.</p>
         <p class="issue" id="issue-396d9a1a"><a class="self-link" href="#issue-396d9a1a"></a> "same authority" here is a placeholder for a future concept that allows user agents to perform <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site③">same site</a> checks while adhering to additional security aspects such as the presence of a cross-site parent document, see <a href="https://github.com/whatwg/storage/issues/142#issuecomment-1122147159">whatwg/storage#142</a>. In practice, this might involve comparing the <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-11#section-5.2.1" id="ref-for-section-5.2.1">site for cookies</a> or performing a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site④">same site</a> check with the top-level document.</p>
        <li data-md>
         <p>If <var>permissionState</var> is <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted">granted</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑦">resolve</a> <var>p</var> with <var>global</var>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access②">has storage access</a>.</p>
         <p class="note" role="note"><span class="marker">Note:</span> The global storage access permission state takes precedence over the local <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access③">has storage access</a> flag here, in order to immediately reflect a possible user choice to revoke the permission in their settings.</p>
        <li data-md>
         <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑧">Resolve</a> <var>p</var> with false.</p>
       </ol>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p>When invoked on <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑧">Document</a></code> <var>doc</var>, the <dfn class="dfn-paneled idl-code" data-dfn-for="Document" data-dfn-type="method" data-export id="dom-document-requeststorageaccess"><code>requestStorageAccess()</code></dfn> method must run these steps:</p>
   <ol>
    <li data-md>
     <p>Let <var>p</var> be <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise①">a new promise</a>.</p>
    <li data-md>
     <p>If <var>doc</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" id="ref-for-fully-active①">fully active</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject①">reject</a> <var>p</var> with an "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror①">InvalidStateError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException①">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>global</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" id="ref-for-concept-relevant-global①">relevant global object</a>.</p>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object③">relevant settings object</a>.</p>
    <li data-md>
     <p>If <var>global</var> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context①">secure context</a>, then <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject②">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException②">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>doc</var> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use" id="ref-for-allowed-to-use①">allowed to use</a> "<code>storage-access</code>", <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject③">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror①">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException③">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin②">origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque②">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject④">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror②">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException④">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>settings</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin③">top-level origin</a> is an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque" id="ref-for-concept-origin-opaque③">opaque origin</a>, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑤">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror③">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑤">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>If <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set" id="ref-for-active-sandboxing-flag-set">active sandboxing flag set</a> has its <a data-link-type="dfn" href="#sandbox-storage-access-by-user-activation-flag" id="ref-for-sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</a> set, <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑥">reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror④">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑥">DOMException</a></code> and return <var>p</var>.</p>
    <li data-md>
     <p>Let <var>browsingContext</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc①">browsing context</a>.</p>
    <li data-md>
     <p>Let <var>topLevelOrigin</var> be the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin④">top-level origin</a> of <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object④">relevant settings object</a>.</p>
    <li data-md>
     <p>Let <var>topLevelSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site②">obtaining a site</a> from <var>topLevelOrigin</var>.</p>
    <li data-md>
     <p>Let <var>embeddedOrigin</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-origin" id="ref-for-concept-document-origin③">origin</a>.</p>
    <li data-md>
     <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site③">obtaining a site</a> from <var>embeddedOrigin</var>.</p>
    <li data-md>
     <p>Let <var>has transient activation</var> be whether <var>doc</var>’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#window" id="ref-for-window">Window</a></code> object has <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#transient-activation" id="ref-for-transient-activation">transient activation</a>.</p>
    <li data-md>
     <p>Run the following steps <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" id="ref-for-in-parallel①">in parallel</a>:</p>
     <ol>
      <li data-md>
       <p>Let <var>process permission state</var> be an algorithm that, given a <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-state" id="ref-for-dfn-permission-state">permission state</a> <var>state</var>, runs the following steps:</p>
       <ol>
        <li data-md>
         <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task" id="ref-for-queue-a-global-task①">Queue a global task</a> on the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source" id="ref-for-networking-task-source①">networking task source</a> given <var>global</var> to:</p>
         <ol>
          <li data-md>
           <p>If <var>state</var> is <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted①">granted</a>:</p>
           <ol>
            <li data-md>
             <p>Set <var>global</var>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access④">has storage access</a> to true.</p>
            <li data-md>
             <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve" id="ref-for-resolve⑨">Resolve</a> <var>p</var> with <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined①">undefined</a></code>.</p>
           </ol>
          <li data-md>
           <p>Else:</p>
           <ol>
            <li data-md>
             <p><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation" id="ref-for-consume-user-activation">Consume user activation</a> given <var>global</var>.</p>
            <li data-md>
             <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject" id="ref-for-reject⑦">Reject</a> <var>p</var> with a "<code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notallowederror" id="ref-for-notallowederror⑤">NotAllowedError</a></code>" <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑦">DOMException</a></code>.</p>
           </ol>
         </ol>
       </ol>
      <li data-md>
       <p>Let <var>explicitSetting</var> be the result of <a data-link-type="dfn" href="#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access" id="ref-for-determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access①">determining whether the user agent explicitly allows unpartitioned cookie access</a> with (<var>topLevelSite</var>, <var>embeddedSite</var>).</p>
      <li data-md>
       <p>If <var>explicitSetting</var> is "<code>disallow</code>":</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-denied" id="ref-for-dfn-denied">denied</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>If <var>explicitSetting</var> is "<code>allow</code>":</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted②">granted</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert②">Assert</a>: <var>explicitSetting</var> is "<code>none</code>".</p>
      <li data-md>
       <p>If <var>browsingContext</var> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context③">top-level browsing context</a>:</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted③">granted</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>If <var>embeddedSite</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site">same site</a> with <var>topLevelSite</var>:</p>
       <p class="note" role="note"><span class="marker">NOTE:</span> This check is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site①">same site</a> on purpose, to allow embedded sites to use <code>requestStorageAccess()</code> to opt into storage access without involvement from the end user in scenarios where storage access is restricted for security and not privacy purposes.</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted④">granted</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>Let <var>previous permission state</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-getting-the-current-permission-state" id="ref-for-dfn-getting-the-current-permission-state①">getting the current permission state</a> given "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access③"><code>storage-access</code></a>" and <var>global</var>.</p>
      <li data-md>
       <p>If <var>previous permission state</var> is not <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-prompt" id="ref-for-dfn-prompt">prompt</a>:</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <var>previous permission state</var>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>Let <var>connected</var> be the result of <a data-link-type="dfn" href="#determine-the-effective-fedcm-connection-status" id="ref-for-determine-the-effective-fedcm-connection-status">determining the effective FedCM connection status</a> given <var>topLevelOrigin</var>, <var>embeddedOrigin</var>, <var>doc</var>.</p>
      <li data-md>
       <p>If <var>connected</var>:</p>
       <p class="note" role="note"><span class="marker">NOTE:</span> User agents are encouraged to keep track of which (site, site) tuples have been allowed to access storage due to existing FedCM connections, and double-check that list when accessing cookies to catch malicious attackers that have tricked an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/#environment" id="ref-for-environment③">environment</a> into using an incorrect <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access⑤">has storage access</a> bit.</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-granted" id="ref-for-dfn-granted⑤">granted</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>If <var>has transient activation</var> is false:</p>
       <ol>
        <li data-md>
         <p>Run <var>process permission state</var> with <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-denied" id="ref-for-dfn-denied①">denied</a>.</p>
        <li data-md>
         <p>Abort these steps.</p>
       </ol>
      <li data-md>
       <p>Let <var>permissionState</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-request-permission-to-use" id="ref-for-dfn-request-permission-to-use">requesting permission to use</a> "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access④"><code>storage-access</code></a>".</p>
       <p class="note" role="note"><span class="marker">NOTE:</span> Note that when requesting permissions and deciding whether to show a prompt, user agents apply implementation-defined behavior to shape the end user experience. Particularly for <code>storage-access</code>, user agents are known to apply custom rules that will grant or deny a permission without showing a prompt.</p>
      <li data-md>
       <p>Run <var>process permission state</var> with <var>permissionState</var>.</p>
     </ol>
    <li data-md>
     <p>Return <var>p</var>.</p>
   </ol>
   <p class="note" role="note"><span class="marker">NOTE:</span> The intent of this algorithm is to always require user activation before a storage-access permission will be set. Though it is within the means of user agents to set storage-access permissions based on custom heuristics without prior user activation, this specification strongly discourages such behavior, as it could lead to interoperability issues.</p>
   <h3 class="heading settled" data-level="3.3" id="navigation"><span class="secno">3.3. </span><span class="content">Changes to navigation</span><a class="self-link" href="#navigation"></a></h3>
   <p>When <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-source-snapshot-params" id="ref-for-snapshotting-source-snapshot-params">snapshotting source snapshot params</a>:</p>
   <ol>
    <li data-md>
     <p>Set <a data-link-type="dfn" href="#source-snapshot-params-has-storage-access" id="ref-for-source-snapshot-params-has-storage-access">has storage access</a> to <var>sourceDocument</var>’s <a data-link-type="dfn" href="#source-snapshot-params-has-storage-access" id="ref-for-source-snapshot-params-has-storage-access①">has storage access</a>.</p>
    <li data-md>
     <p>Set <a data-link-type="dfn" href="#source-snapshot-params-environment-id" id="ref-for-source-snapshot-params-environment-id">environment id</a> to <var>sourceDocument</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object⑤">relevant settings object</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id" id="ref-for-concept-environment-id">id</a>.</p>
   </ol>
   <p>To the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching" id="ref-for-create-navigation-params-by-fetching">create navigation params by fetching</a> algorithm, insert the following step as step 3:</p>
   <ol>
    <li data-md>
     <p>Let <var>originalURL</var> be <var>entry</var>’s URL.</p>
   </ol>
   <p>When creating <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-reserved-client" id="ref-for-concept-request-reserved-client">reserved client</a> in <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching" id="ref-for-create-navigation-params-by-fetching①">create navigation params by fetching</a>:</p>
   <ol>
    <li data-md>
     <p>Set <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-reserved-client" id="ref-for-concept-request-reserved-client①">reserved client</a>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access⑥">has storage access</a> to <var>sourceSnapshotParams</var>’s <a data-link-type="dfn" href="#source-snapshot-params-has-storage-access" id="ref-for-source-snapshot-params-has-storage-access②">has storage access</a> if all of the following hold:</p>
     <ol>
      <li data-md>
       <p><var>sourceSnapshotParams</var>’s <a data-link-type="dfn" href="#source-snapshot-params-environment-id" id="ref-for-source-snapshot-params-environment-id①">environment id</a> equals <var>navigable</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document③">active document</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object⑥">relevant settings object</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id" id="ref-for-concept-environment-id①">id</a>.</p>
      <li data-md>
       <p><var>originalURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin②">origin</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin①">same origin</a> with <var>currentURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin③">origin</a>.</p>
      <li data-md>
       <p><var>response</var> is null or <var>response</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#response-has-cross-origin-redirects" id="ref-for-response-has-cross-origin-redirects">has-cross-origin-redirects</a> is false.</p>
     </ol>
    <li data-md>
     <p>Otherwise, set <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-reserved-client" id="ref-for-concept-request-reserved-client②">reserved client</a>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access⑦">has storage access</a> to false.</p>
   </ol>
   <p>When <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#set-up-a-window-environment-settings-object" id="ref-for-set-up-a-window-environment-settings-object">setting up a window environment settings object</a>:</p>
   <ol>
    <li data-md>
     <p>Set <var>settings object</var>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access⑧">has storage access</a> to <var>reserved environment</var>’s <a data-link-type="dfn" href="#environment-has-storage-access" id="ref-for-environment-has-storage-access⑨">has storage access</a>.</p>
   </ol>
   <h3 class="heading settled" data-level="3.4" id="fetch-integration"><span class="secno">3.4. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#fetch-integration"></a></h3>
   <h4 class="heading settled" data-level="3.4.1" id="fetching"><span class="secno">3.4.1. </span><span class="content">Fetching</span><a class="self-link" href="#fetching"></a></h4>
   <p>Insert a new step after step 14 of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-fetch" id="ref-for-concept-fetch">fetch</a>:</p>
   <div class="algorithm" data-algorithm="modified fetching">
    <ol start="15">
     <li data-md>
      <p>Set <var>request</var>’s <a data-link-type="dfn" href="#request-eligible-for-storage-access" id="ref-for-request-eligible-for-storage-access">eligible for storage-access</a> to the result of <a data-link-type="dfn" href="#determine-the-initial-storage-access-eligibility" id="ref-for-determine-the-initial-storage-access-eligibility">determining the initial storage-access eligibility</a> given <var>request</var>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="3.4.2" id="http-redirect-fetch"><span class="secno">3.4.2. </span><span class="content">HTTP-redirect-fetch</span><a class="self-link" href="#http-redirect-fetch"></a></h4>
   <p>Insert a new step after step 17 of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-redirect-fetch" id="ref-for-concept-http-redirect-fetch">HTTP-redirect fetch</a>:</p>
   <div class="algorithm" data-algorithm="modified HTTP-redirect fetch">
    <ol start="18">
     <li data-md>
      <p>If <var>request</var>’s <a data-link-type="dfn" href="#request-eligible-for-storage-access" id="ref-for-request-eligible-for-storage-access①">eligible for storage-access</a> is not "<code><a data-link-type="dfn" href="#storage-access-eligibility-unset" id="ref-for-storage-access-eligibility-unset③">unset</a></code>" and <var>locationURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin④">origin</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin②">same origin</a> with <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url" id="ref-for-concept-request-current-url">current URL</a>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin⑤">origin</a>, set <var>request</var>’s <a data-link-type="dfn" href="#request-eligible-for-storage-access" id="ref-for-request-eligible-for-storage-access②">eligible for storage-access</a> to "<code><a data-link-type="dfn" href="#storage-access-eligibility-ineligible" id="ref-for-storage-access-eligibility-ineligible③">ineligible</a></code>".</p>
    </ol>
   </div>
   <h3 class="heading settled" data-level="3.5" id="storage"><span class="secno">3.5. </span><span class="content">Changes to various client-side storage mechanisms</span><a class="self-link" href="#storage"></a></h3>
   <p>This API only impacts HTTP cookies. A future revision of this API might impact other client-side state. <a data-link-type="biblio" href="#biblio-rfc6265" title="HTTP State Management Mechanism">[RFC6265]</a></p>
   <h4 class="heading settled" data-level="3.5.1" id="cookies"><span class="secno">3.5.1. </span><span class="content">Cookies</span><a class="self-link" href="#cookies"></a></h4>
   <p>This API is intended to be used with environments and user agent configurations that block access to unpartitioned cookies in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context①">third party context</a>. At the time of this writing, this concept has not yet been integrated into the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch">HTTP-network-or-cache fetch</a> and <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie" id="ref-for-dom-document-cookie①">cookie</a></code> algorithms. To allow for such an integration, the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-5.3" id="ref-for-section-5.3">cookie store</a> will need to be modified to receive information about the top-level and embedded site of the request (to determine whether to attach cross-site, partitioned, or no cookies) as well as whether the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑤">request</a> was made for a document that has storage access, through accessing the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑥">request</a>’s <a data-link-type="dfn" href="#request-eligible-for-storage-access" id="ref-for-request-eligible-for-storage-access③">eligible for storage-access</a> that is defined in this specification.</p>
   <p>Once the cookie store allows for receiving information about storage access, we would update <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch" id="ref-for-concept-http-network-or-cache-fetch①">HTTP-network-or-cache fetch</a> and <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie" id="ref-for-dom-document-cookie②">cookie</a></code> to pass the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request⑦">request</a>’s <a data-link-type="dfn" href="#request-eligible-for-storage-access" id="ref-for-request-eligible-for-storage-access④">eligible for storage-access</a> to the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-5.3" id="ref-for-section-5.3①">cookie store</a> when retrieving cookies.</p>
   <p>When getting unpartitioned cookies from the <a data-link-type="dfn" href="https://tools.ietf.org/html/rfc6265#section-5.3" id="ref-for-section-5.3②">cookie store</a> with storage access, user agents will still follow applicable <code>SameSite</code> restrictions (i.e., not attach cookies marked <code>SameSite=Strict</code> or <code>SameSite=Lax</code> in <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context②">third party contexts</a>).</p>
   <p class="note" role="note"><span class="marker">Note:</span> User agents could apply different default values for the <code>SameSite</code> cookie attribute. This could lead to unpartitioned cookies without a <code>SameSite</code> attribute being attached to requests in some user agents (where <code>SameSite=None</code> is the default), but not in others (where <code>SameSite=Lax</code> is the default). Web developers are encouraged to set the <code>SameSite</code> attribute on their cookies to not run into issues.</p>
   <h3 class="heading settled" data-level="3.6" id="sandboxing-storage-access"><span class="secno">3.6. </span><span class="content">Sandboxing storage access</span><a class="self-link" href="#sandboxing-storage-access"></a></h3>
   <p>A <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set" id="ref-for-sandboxing-flag-set">sandboxing flag set</a> has a <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</dfn>. This flag prevents content from requesting storage access.</p>
   <p>To the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive" id="ref-for-parse-a-sandboxing-directive">parse a sandboxing directive</a> algorithm, add the following under step 3:</p>
   <ul>
    <li>The <a data-link-type="dfn" href="#sandbox-storage-access-by-user-activation-flag" id="ref-for-sandbox-storage-access-by-user-activation-flag①">sandbox storage access by user activation flag</a>, unless <var>tokens</var> contains the <dfn class="dfn-paneled" data-dfn-for="iframe/sandbox" data-dfn-type="attr-value" data-export id="attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation"><code>allow-storage-access-by-user-activation</code></dfn> keyword. 
   </ul>
   <h2 class="heading settled" data-level="4" id="permissions-integration"><span class="secno">4. </span><span class="content">Permissions Integration</span><a class="self-link" href="#permissions-integration"></a></h2>
   <p>The Storage Access API defines a <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-powerful-feature" id="ref-for-dfn-powerful-feature">powerful feature</a> identified by the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-name" id="ref-for-dfn-name">name</a> "<dfn class="dfn-paneled idl-code" data-dfn-type="permission" data-export id="permissiondef-storage-access"><code>storage-access</code></dfn>". It defines the following permission-related algorithms:</p>
   <dl>
    <dt><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-query-algorithm" id="ref-for-dfn-permission-query-algorithm">permission query algorithm</a>
    <dd>
      To query the "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access⑤"><code>storage-access</code></a>" permission, given a <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissiondescriptor" id="ref-for-dom-permissiondescriptor">PermissionDescriptor</a></code> <var>permissionDesc</var> and a <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissionstatus" id="ref-for-dom-permissionstatus">PermissionStatus</a></code> <var>status</var>: 
     <ol>
      <li data-md>
       <p>Set <var>status</var>’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissionstatus-state" id="ref-for-dom-permissionstatus-state">state</a></code> to <var>permissionDesc</var>’s <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-state" id="ref-for-dfn-permission-state①">permission state</a>.</p>
      <li data-md>
       <p>If <var>status</var>’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissionstatus-state" id="ref-for-dom-permissionstatus-state①">state</a></code> is <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-denied" id="ref-for-dfn-denied②">denied</a>, set <var>status</var>’s <code class="idl"><a data-link-type="idl" href="https://w3c.github.io/permissions/#dom-permissionstatus-state" id="ref-for-dom-permissionstatus-state②">state</a></code> to <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-prompt" id="ref-for-dfn-prompt①">prompt</a>.</p>
       <p class="note" role="note"><span class="marker">Note:</span> The "denied" permission state is not revealed to avoid exposing the user’s decision to developers. This is done to prevent retaliation against the user and repeated prompting to the detriment of the user experience.</p>
     </ol>
    <dt><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key-type" id="ref-for-dfn-permission-key-type">permission key type</a>
    <dd>
      A <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key" id="ref-for-dfn-permission-key">permission key</a> of the "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access⑥"><code>storage-access</code></a>" feature is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#tuple" id="ref-for-tuple①">tuple</a> consisting of a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site②">site</a> <dfn class="dfn-paneled" data-dfn-for="permission key" data-dfn-type="dfn" data-noexport id="permission-key-top-level">top-level</dfn> and a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site③">site</a> <dfn class="dfn-paneled" data-dfn-for="permission key" data-dfn-type="dfn" data-noexport id="permission-key-requester">requester</dfn>. 
     <div class="example" id="example-82f4f666">
      <a class="self-link" href="#example-82f4f666"></a> 
      <p><code>(("https", "news.example"), ("https", "social.example"))</code> is a <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key" id="ref-for-dfn-permission-key①">permission key</a> for "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access⑦"><code>storage-access</code></a>" whose <a data-link-type="dfn" href="#permission-key-top-level" id="ref-for-permission-key-top-level">top-level</a> is <code>("https", "news.example")</code> and whose <a data-link-type="dfn" href="#permission-key-requester" id="ref-for-permission-key-requester">requester</a> is <code>("https", "social.example")</code>.</p>
     </div>
    <dt><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key-generation-algorithm" id="ref-for-dfn-permission-key-generation-algorithm">permission key generation algorithm</a>
    <dd>
      To generate a new <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key" id="ref-for-dfn-permission-key②">permission key</a> for the "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access⑧"><code>storage-access</code></a>" feature, given an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" id="ref-for-environment-settings-object">environment settings object</a> <var>settings</var>, run the following steps: 
     <ol>
      <li data-md>
       <p>Let <var>topLevelSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site④">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin" id="ref-for-concept-environment-top-level-origin⑤">top-level origin</a>.</p>
      <li data-md>
       <p>Let <var>embeddedSite</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site⑤">obtaining a site</a> from <var>settings</var>’ <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin①">origin</a>.</p>
      <li data-md>
       <p>Return (<var>topLevelSite</var>, <var>embeddedSite</var>).</p>
     </ol>
    <dt><a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key-comparison-algorithm" id="ref-for-dfn-permission-key-comparison-algorithm">permission key comparison algorithm</a>
    <dd>
      To compare the <a data-link-type="dfn" href="https://w3c.github.io/permissions/#dfn-permission-key" id="ref-for-dfn-permission-key③">permission keys</a> <var>key1</var> and <var>key2</var> for the "<a class="idl-code" data-link-type="permission" href="#permissiondef-storage-access" id="ref-for-permissiondef-storage-access⑨"><code>storage-access</code></a>" feature, run the following steps: 
     <ol>
      <li data-md>
       <p>If <var>key1</var>’s <a data-link-type="dfn" href="#permission-key-top-level" id="ref-for-permission-key-top-level①">top-level</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site②">same site</a> with <var>key2</var>’s <a data-link-type="dfn" href="#permission-key-top-level" id="ref-for-permission-key-top-level②">top-level</a>, return false.</p>
      <li data-md>
       <p>If <var>key1</var>’s <a data-link-type="dfn" href="#permission-key-requester" id="ref-for-permission-key-requester①">requester</a> is not <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site③">same site</a> with <var>key2</var>’s <a data-link-type="dfn" href="#permission-key-requester" id="ref-for-permission-key-requester②">requester</a>, return false.</p>
      <li data-md>
       <p>Return true.</p>
     </ol>
   </dl>
   <h2 class="heading settled" data-level="5" id="permissions-policy-integration"><span class="secno">5. </span><span class="content">Permissions Policy Integration</span><a class="self-link" href="#permissions-policy-integration"></a></h2>
   <p>The Storage Access API defines a <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature" id="ref-for-policy-controlled-feature">policy-controlled feature</a> identified by the string <code>"storage-access"</code>. Its <a data-link-type="dfn" href="https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist" id="ref-for-policy-controlled-feature-default-allowlist">default allowlist</a> is <code>"*"</code>.</p>
   <p class="note" role="note"><span class="marker">Note:</span> A <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document⑨">Document</a></code>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#concept-document-permissions-policy" id="ref-for-concept-document-permissions-policy">permissions policy</a> determines whether any content in that document is allowed to request storage access using <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess⑤">requestStorageAccess()</a></code>. If disabled in any document, calling <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess⑥">requestStorageAccess()</a></code> in that document will reject.</p>
   <h2 class="heading settled" data-level="6" id="privacy"><span class="secno">6. </span><span class="content">Privacy considerations</span><a class="self-link" href="#privacy"></a></h2>
   <p>The Storage Access API enables the removal of cross-site cookies. Specifically, it allows the authenticated embeds use case to continue to work. As such, the API provides a way for developers to re-gain access to cross-site cookies, albeit under further constraints.</p>
   <p>A nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⓪">Document</a></code> gains access to the same cookies it has as the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document④">active document</a> of a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context④">top-level browsing context</a> when it calls <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess⑦">requestStorageAccess()</a></code> and is returned a resolving <code class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise②">Promise</a></code>. With these cookies it can authenticate itself to the server and load user-specific information.</p>
   <p>While this functionality comes with a risk of abuse by third parties for tracking purposes, it is an explicit goal of the API and a key to its design to not undermine the gains of cross-site cookie deprecation.
Importantly, we do not degrade privacy properties when compared to pre-removal of cross-site cookies. This follows from a lack of platform-specific information used in the spec to prevent stateless tracking and the only state added being a permission scoped to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site④">sites</a> of the embedding and embedded <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①①">Document</a></code>.</p>
   <p>Our privacy considerations are more challenging where default cross-site cookies are already deprecated. The challenge is to decide when and how to permit the Storage Access API to be used to revert a cookie-less (or cookie-partitioned) nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①②">Document</a></code> to a pre-deprecation state, giving it access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data②">unpartitioned data</a>.</p>
   <p>In an ideal case, a nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①③">Document</a></code> would only be able to gain access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data③">unpartitioned data</a> if:</p>
   <ol>
    <li data-md>
     <p>the user interacts with the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①④">Document</a></code></p>
    <li data-md>
     <p>the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⑤">Document</a></code> is permitted by the embedder to use the API</p>
    <li data-md>
     <p>the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⑥">Document</a></code> is a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context②">secure context</a></p>
    <li data-md>
     <p>the user grants express, pairwise permission to the embeddee to use its cookies in the embedder</p>
    <li data-md>
     <p>the user is not inundated by requests for the "<code>storage-access</code>" permission so their express permission is not undermined by fatigue</p>
   </ol>
   <p>This specification requires the first three of implementers. This provides guarantees that the user is aware of the content of the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⑦">Document</a></code>, the embedder has not opted out of the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⑧">Document</a></code>’s authentication, and the cross-site cookies are not disclosed to network attackers, respectively.</p>
   <p>The last two points are in tension. In an ideal world, we would show a prompt to the user in every call to <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess⑧">requestStorageAccess()</a></code>. But, this would allow pages to prompt the user so frequently as to put the last point at the discretion of the page– a state we find unacceptable. User agents should prevent over-prompting of the user.</p>
   <figure id="example-prompt">
     <img alt="A modal dialog box which states &apos;Do you want to allow “video.example” to use cookies and website data while browsing “news.example”? This will allow “video.example” to track your activity.&apos; and which has two buttons, “Don’t Allow” and “Allow”." height="266" src="images/storage-access-prompt.png" width="840"> 
    <figcaption>An example prompt which could be shown to the user when a site calls <code>document.</code><code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess⑨">requestStorageAccess()</a></code>.</figcaption>
   </figure>
   <p>Thus, the last two points represent a key point of compromise. We permit <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> behavior on when to grant or deny requests for <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data④">unpartitioned data</a> without requiring user choice so long as they meet all other requirements. This compromise weakens the privacy guarantees of this proposal, specifically point 4, to a degree under the control of the implementer and gives the implementer the power to render it impossible to get storage access with this API. However, this has proven necessary to enable condition 5 to be possible given our implementers' differing stances on the compromise between these two points.</p>
   <p>Developer experience suffers where user agents differ greatly in their <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined①">implementation-defined</a> behavior, and therefore user agents should aim to minimize or standardize silent grants and denies.</p>
   <h3 class="heading settled" data-level="6.1" id="site-scope"><span class="secno">6.1. </span><span class="content">Permission scope</span><a class="self-link" href="#site-scope"></a></h3>
   <p>Another tension in the design of the API is what to use to key the "<code>storage-access</code>" permission: <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin④">origins</a> or <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑤">sites</a>. We chose <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#site" id="ref-for-site⑥">sites</a> because we believe them to be acceptable boundaries for privacy while enabling existing uses of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site" id="ref-for-concept-site-same-site④">same site</a> and cross-origin nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①⑨">Documents</a></code> on the same page with only one user prompt.</p>
   <h2 class="heading settled" data-level="7" id="security"><span class="secno">7. </span><span class="content">Security considerations</span><a class="self-link" href="#security"></a></h2>
   <p>It is important that this spec not degrade security properties of the web platform, even when compared to post-removal of cross-site cookies. Third-party cookie removal has potential benefits for security, specifically in mitigating attacks that rely upon authenticated requests, e.g. CSRF. We do not wish the Storage Access API to be a foothold for such attacks to leverage.</p>
   <p>To this end, we limit the impact of a "<code>storage-access</code>" permission grant to only give access to <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑤">unpartitioned data</a> to the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②⓪">Document</a></code> that called <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess①⓪">requestStorageAccess()</a></code> and only until the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②①">Document</a></code> navigates across an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑤">origin</a> boundary. This ensures that only <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑥">origins</a> with a page that call <code class="idl"><a data-link-type="idl" href="#dom-document-requeststorageaccess" id="ref-for-dom-document-requeststorageaccess①①">requestStorageAccess()</a></code> will be making credentialed requests, and moreover the embedee page can control which embedder it permits via the Content Security Policy "<code>frame-ancestors</code>" directive. This retains an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin" id="ref-for-concept-origin⑦">origin</a>-scoped control for security purposes by the embedee.</p>
   <h3 class="heading settled" data-level="7.1" id="reputation"><span class="secno">7.1. </span><span class="content">Reputational attacks</span><a class="self-link" href="#reputation"></a></h3>
   <p>This also is effective at preventing another attack: one on the embedee’s reputation. We consider any cross-site authenticated request to have potential reputational harm as consumers become more privacy conscious. Therefore a first-party or sibling cross-site causing an embedded resource to be requested with the user’s authentication cookies would constitute an attack on the reputation of that cross-site’s owner. This is also a reason we require this API to be used in a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#secure-context" id="ref-for-secure-context③">secure context</a>: so a network adversary cannot induce an embedee to use this API.</p>
   <p>The embedder has control over which nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②②">Documents</a></code> have the ability to become authenticated, or even display a permission request to the user via the Permission Policy and nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②③">Document</a></code> sandboxing.</p>
   <h3 class="heading settled" data-level="7.2" id="notification"><span class="secno">7.2. </span><span class="content">Notification abuse</span><a class="self-link" href="#notification"></a></h3>
   <p>Notification abuse was also considered while specifying the Storage Access API. Specifically, we require user interaction in the nested <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document②④">Document</a></code> and consume that rejection on a denial to restrict the conditions a permission prompt will be shown to the user. This mitigates attacks such as re-requesting a permission immediately after the user denies it.</p>
   <h2 class="heading settled" data-level="8" id="automation"><span class="secno">8. </span><span class="content">Automation</span><a class="self-link" href="#automation"></a></h2>
   <p>For the purposes of user-agent automation and application testing, this document defines the following <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands" id="ref-for-dfn-extension-commands">extension command</a> for the <a data-link-type="biblio" href="#biblio-webdriver" title="WebDriver">[WebDriver]</a> specification.</p>
   <h3 class="heading settled" data-level="8.1" id="set-storage-access-command"><span class="secno">8.1. </span><span class="content">Set Storage Access</span><a class="self-link" href="#set-storage-access-command"></a></h3>
   <table>
    <tbody>
     <tr>
      <th>HTTP Method
      <th>URI Template
     <tr>
      <td>POST
      <td>/session/{session id}/storageaccess
   </table>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-export id="set-storage-access">Set Storage Access</dfn> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands" id="ref-for-dfn-extension-commands①">extension command</a> modifies the storage access policy for the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context">current browsing context</a>.</p>
   <p>The <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps" id="ref-for-dfn-remote-end-steps">remote end steps</a> are:</p>
   <ol>
    <li data-md>
     <p>Let <var>blocked</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties" id="ref-for-dfn-getting-properties">getting a property</a> from <var>parameters</var> named <code>blocked</code>.</p>
    <li data-md>
     <p>If <var>blocked</var> is not a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#boolean" id="ref-for-boolean④">boolean</a> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument" id="ref-for-dfn-invalid-argument">invalid argument</a>.</p>
    <li data-md>
     <p>Let <var>embedded origin</var> be the result of <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties" id="ref-for-dfn-getting-properties①">getting a property</a> from <var>parameters</var> named <code>origin</code>.</p>
    <li data-md>
     <p>If <var>embedded origin</var> is not a single U+002A ASTERISK character (*), then:</p>
     <ol>
      <li data-md>
       <p>Let <var>parsedURL</var> be the the result of running the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser">URL parser</a> on <var>embedded origin</var>.</p>
      <li data-md>
       <p>If <var>parsedURL</var> is failure, then return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error①">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code①">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument" id="ref-for-dfn-invalid-argument①">invalid argument</a>.</p>
      <li data-md>
       <p>Set <var>embedded origin</var> to <var>parsedURL</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin⑥">origin</a>.</p>
     </ol>
    <li data-md>
     <p>If the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context①">current browsing context</a> is not a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context" id="ref-for-top-level-browsing-context⑤">top-level browsing context</a> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error②">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code②">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation" id="ref-for-dfn-unsupported-operation">unsupported operation</a>.</p>
    <li data-md>
     <p>Let <var>doc</var> be the <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context" id="ref-for-dfn-current-browsing-context②">current browsing context</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document⑤">active document</a>.</p>
    <li data-md>
     <p>Let <var>settings</var> be <var>doc</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" id="ref-for-relevant-settings-object⑦">relevant settings object</a>.</p>
    <li data-md>
     <p>Let <var>top-level site</var> be the result of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site" id="ref-for-obtain-a-site⑥">obtaining a site</a> from <var>settings</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin②">origin</a>.</p>
    <li data-md>
     <p>If <var>embedded origin</var> is a single U+002A ASTERISK character (*), then:</p>
     <ol>
      <li data-md>
       <p>If <var>blocked</var> is <code>true</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined②">implementation-defined</a> set of steps to ensure that no site has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑥">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context③">third party context</a> on <var>top-level site</var>.</p>
       </ol>
      <li data-md>
       <p>Otherwise, if <var>blocked</var> is <code>false</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined③">implementation-defined</a> set of steps to ensure that any site has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑦">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context④">third party context</a> on <var>top-level site</var>.</p>
       </ol>
     </ol>
    <li data-md>
     <p>Otherwise:</p>
     <ol>
      <li data-md>
       <p>If <var>embedded origin</var> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site" id="ref-for-same-site⑤">same site</a> with <var>settings</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin" id="ref-for-concept-settings-object-origin③">origin</a> return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error③">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code③">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation" id="ref-for-dfn-unsupported-operation①">unsupported operation</a>.</p>
      <li data-md>
       <p>If <var>blocked</var> is <code>true</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined④">implementation-defined</a> set of steps to ensure that <var>embedded origin</var> does not have access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑧">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑤">third party context</a> on <var>top-level site</var>.</p>
       </ol>
      <li data-md>
       <p>Otherwise, if <var>blocked</var> is <code>false</code>, then:</p>
       <ol>
        <li data-md>
         <p>Run an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑤">implementation-defined</a> set of steps to ensure that <var>embedded origin</var> has access to its <a data-link-type="dfn" href="#unpartitioned-data" id="ref-for-unpartitioned-data⑨">unpartitioned data</a> when loaded in a <a data-link-type="dfn" href="#third-party-context" id="ref-for-third-party-context⑥">third party context</a> on <var>top-level site</var>.</p>
       </ol>
     </ol>
    <li data-md>
     <p>If the above <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined⑥">implementation-defined</a> step of steps resulted in failure, return a <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error" id="ref-for-dfn-error④">WebDriver error</a> with <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code" id="ref-for-dfn-error-code④">WebDriver error code</a> <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error" id="ref-for-dfn-unknown-error">unknown error</a>.</p>
    <li data-md>
     <p>Return <a data-link-type="dfn" href="https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success" id="ref-for-dfn-success">success</a> with data <code>null</code>.</p>
   </ol>
   <h2 class="no-num heading settled" id="acknowledgements"><span class="content">Acknowledgements</span><a class="self-link" href="#acknowledgements"></a></h2>
   <p>This specification builds on the foundations created by former editors John Wilander, who invented the Storage Access API, and Theresa O’Connor, who wrote significant portions of the initial text. We are grateful for their ideas and contributions.</p>
   <p>Many thanks to
Anne van Kesteren,
Ben Kelly,
Brad Girardeau,
Brad Hill,
Brady Eidson,
Brandon Maslen,
Chris Mills,
Dave Longley,
Domenic Denicola,
Ehsan Akhgari,
Geoffrey Garen,
Jack Frankland,
James Coleman,
James Hartig,
Jeffrey Yasskin,
Kushal Dave,
Luís Rudge,
Maciej Stachowiak,
Matias Woloski,
Mike O’Neill,
Mike West,
Pete Snyder,
Rob Stone,
Stefan Leyhane,
Steven Englehardt,
Travis Leithead,
Yan Zhu,
Zach Edwards,
and everyone who commented on <a href="https://github.com/whatwg/html/issues/3338">whatwg/html#3338</a>, <a href="https://github.com/privacycg/proposals/issues/2">privacycg/proposals#2</a>, and <a href="https://github.com/privacycg/storage-access/issues">privacycg/storage-access/issues</a> for their feedback on this proposal.</p>
   <p>Thanks to the <a href="https://webkit.org/">WebKit Open Source Project</a> for allowing us to use the <a href="#example-prompt">Storage Access API Prompt</a> image, which was <a href="https://webkit.org/blog/8311/intelligent-tracking-prevention-2-0/">originally published on webkit.org</a>.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation">allow-storage-access-by-user-activation</a><span>, in § 3.6</span>
   <li><a href="#determine-the-effective-fedcm-connection-status">determine the effective FedCM connection status</a><span>, in § 3</span>
   <li><a href="#determine-the-fedcm-site-connection-status">determine the FedCM site connection status</a><span>, in § 3</span>
   <li><a href="#determine-the-initial-storage-access-eligibility">determine the initial storage-access eligibility</a><span>, in § 3.1</span>
   <li><a href="#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access">determine whether the user agent explicitly allows unpartitioned cookie access</a><span>, in § 3</span>
   <li><a href="#storage-access-eligibility-eligible">eligible</a><span>, in § 3.1</span>
   <li><a href="#request-eligible-for-storage-access">eligible for storage-access</a><span>, in § 3.1</span>
   <li><a href="#source-snapshot-params-environment-id">environment id</a><span>, in § 3.1</span>
   <li><a href="#first-party-site-context">first-party-site context</a><span>, in § 3</span>
   <li>
    has storage access
    <ul>
     <li><a href="#environment-has-storage-access">dfn for environment</a><span>, in § 3.1</span>
     <li><a href="#source-snapshot-params-has-storage-access">dfn for source snapshot params</a><span>, in § 3.1</span>
    </ul>
   <li><a href="#dom-document-hasstorageaccess">hasStorageAccess()</a><span>, in § 3.2</span>
   <li><a href="#storage-access-eligibility-ineligible">ineligible</a><span>, in § 3.1</span>
   <li><a href="#permission-key-requester">requester</a><span>, in § 4</span>
   <li><a href="#dom-document-requeststorageaccess">requestStorageAccess()</a><span>, in § 3.2</span>
   <li><a href="#sandbox-storage-access-by-user-activation-flag">sandbox storage access by user activation flag</a><span>, in § 3.6</span>
   <li><a href="#set-storage-access">Set Storage Access</a><span>, in § 8.1</span>
   <li><a href="#permissiondef-storage-access">storage-access</a><span>, in § 4</span>
   <li><a href="#storage-access-eligibility">storage access eligibility</a><span>, in § 3.1</span>
   <li><a href="#third-party-context">third party context</a><span>, in § 3</span>
   <li><a href="#permission-key-top-level">top-level</a><span>, in § 4</span>
   <li><a href="#unpartitioned-data">Unpartitioned data</a><span>, in § 3</span>
   <li><a href="#storage-access-eligibility-unset">unset</a><span>, in § 3.1</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CREDENTIAL-MANAGEMENT-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="434cbb10">credential store</span>
     <li><span class="dfn-paneled" id="f52ea2e1">prevent silent access flag</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="c62cd7cf">origin</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FEDCM-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="1cdbf0c6">connected accounts set</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="3f2ca4de">current URL</span>
     <li><span class="dfn-paneled" id="a33db89a">fetch</span>
     <li><span class="dfn-paneled" id="5a330bbb">has-cross-origin-redirects</span>
     <li><span class="dfn-paneled" id="980528b0">http-network-or-cache fetch</span>
     <li><span class="dfn-paneled" id="8acee9c8">http-redirect fetch</span>
     <li><span class="dfn-paneled" id="55213b5b">request</span>
     <li><span class="dfn-paneled" id="abe352cd">reserved client</span>
     <li><span class="dfn-paneled" id="dc1cd39b">URL</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5d7209e9">Window</span>
     <li><span class="dfn-paneled" id="35972864">active document</span>
     <li><span class="dfn-paneled" id="27e10eaf">active sandboxing flag set</span>
     <li><span class="dfn-paneled" id="3610bd67">allowed to use</span>
     <li><span class="dfn-paneled" id="45fae3a4">ancestry</span>
     <li><span class="dfn-paneled" id="3b2ff63e">browsing context</span>
     <li><span class="dfn-paneled" id="aca22383">consume user activation</span>
     <li><span class="dfn-paneled" id="a1e6e861">cookie</span>
     <li><span class="dfn-paneled" id="07ad3048">create navigation params by fetching</span>
     <li><span class="dfn-paneled" id="0e5e4e32">environment</span>
     <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
     <li><span class="dfn-paneled" id="0e3ba9f8">fully active</span>
     <li><span class="dfn-paneled" id="73a186aa">id</span>
     <li><span class="dfn-paneled" id="87fcd40c">iframe</span>
     <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
     <li><span class="dfn-paneled" id="b6ae4501">networking task source</span>
     <li><span class="dfn-paneled" id="602b1a68">obtain a site</span>
     <li><span class="dfn-paneled" id="b01b1359">opaque origin</span>
     <li><span class="dfn-paneled" id="086e3aff">origin</span>
     <li><span class="dfn-paneled" id="43ac8374">origin <small>(for environment settings object)</small></span>
     <li><span class="dfn-paneled" id="53f0ea4e">parse a sandboxing directive</span>
     <li><span class="dfn-paneled" id="a41102eb">permissions policy</span>
     <li><span class="dfn-paneled" id="48438eb3">queue a global task</span>
     <li><span class="dfn-paneled" id="e99bd18e">relevant global object</span>
     <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="feac4ab3">same site</span>
     <li><span class="dfn-paneled" id="f0482ed2">same site <small>(for site)</small></span>
     <li><span class="dfn-paneled" id="457a6f4c">sandboxing flag set</span>
     <li><span class="dfn-paneled" id="65181da8">secure context</span>
     <li><span class="dfn-paneled" id="66f104fd">set up a window environment settings object</span>
     <li><span class="dfn-paneled" id="fb9bb722">site</span>
     <li><span class="dfn-paneled" id="42f00e01">snapshotting source snapshot params</span>
     <li><span class="dfn-paneled" id="77093875">source snapshot params</span>
     <li><span class="dfn-paneled" id="ae2a6342">top-level browsing context</span>
     <li><span class="dfn-paneled" id="c63519ed">top-level origin</span>
     <li><span class="dfn-paneled" id="47fe679e">transient activation</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="77b4c09a">assert</span>
     <li><span class="dfn-paneled" id="36858240">boolean</span>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
     <li><span class="dfn-paneled" id="f02cd417">iterate</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="0e8de730">tuple</span>
     <li><span class="dfn-paneled" id="6d19ac93">user agent</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="ebb01253">PermissionDescriptor</span>
     <li><span class="dfn-paneled" id="dbf8e074">PermissionStatus</span>
     <li><span class="dfn-paneled" id="fb4878d7">denied</span>
     <li><span class="dfn-paneled" id="33438879">getting the current permission state</span>
     <li><span class="dfn-paneled" id="6821ab89">granted</span>
     <li><span class="dfn-paneled" id="e740d7e5">name</span>
     <li><span class="dfn-paneled" id="2f495016">permission key</span>
     <li><span class="dfn-paneled" id="a98e2e2c">permission key comparison algorithm</span>
     <li><span class="dfn-paneled" id="951ae231">permission key generation algorithm</span>
     <li><span class="dfn-paneled" id="79bfe9df">permission key type</span>
     <li><span class="dfn-paneled" id="7ee1f942">permission query algorithm</span>
     <li><span class="dfn-paneled" id="d124397f">permission state</span>
     <li><span class="dfn-paneled" id="6c2d7879">powerful feature</span>
     <li><span class="dfn-paneled" id="b2915302">prompt</span>
     <li><span class="dfn-paneled" id="d357c753">requesting permission to use</span>
     <li><span class="dfn-paneled" id="620f832e">state</span>
    </ul>
   <li>
    <a data-link-type="biblio">[PERMISSIONS-POLICY-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="c7141347">Should request be allowed to use feature?</span>
     <li><span class="dfn-paneled" id="1570624a">default allowlist</span>
     <li><span class="dfn-paneled" id="cc890cc1">policy-controlled feature</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6265]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="19353784">cookie store</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC6265BIS]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b8623307">site for cookies</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="959ad97b">origin</span>
     <li><span class="dfn-paneled" id="ca3ca4ae">URL parser</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WebDriver]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d695a1e4">current browsing context</span>
     <li><span class="dfn-paneled" id="64eb4e66">extension command</span>
     <li><span class="dfn-paneled" id="ae66758d">getting a property</span>
     <li><span class="dfn-paneled" id="48968b5b">invalid argument</span>
     <li><span class="dfn-paneled" id="5661b7f6">remote end steps</span>
     <li><span class="dfn-paneled" id="986c69cd">success</span>
     <li><span class="dfn-paneled" id="2dfbf26c">unknown error</span>
     <li><span class="dfn-paneled" id="87b50d92">unsupported operation</span>
     <li><span class="dfn-paneled" id="991d0ba3">WebDriver error</span>
     <li><span class="dfn-paneled" id="c45850fd">WebDriver error code</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="dca2de17">DOMException</span>
     <li><span class="dfn-paneled" id="797018a7">InvalidStateError</span>
     <li><span class="dfn-paneled" id="ba556545">NotAllowedError</span>
     <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
     <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
     <li><span class="dfn-paneled" id="5372cca8">boolean</span>
     <li><span class="dfn-paneled" id="b262501e">reject</span>
     <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
     <li><span class="dfn-paneled" id="5f90bbfb">undefined</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-credential-management-1">[CREDENTIAL-MANAGEMENT-1]
   <dd>Nina Satragno; Marcos Caceres. <a href="https://w3c.github.io/webappsec-credential-management/"><cite>Credential Management Level 1</cite></a>. URL: <a href="https://w3c.github.io/webappsec-credential-management/">https://w3c.github.io/webappsec-credential-management/</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fedcm-1">[FEDCM-1]
   <dd>Nicolas Pena Moreno. <a href="https://w3c-fedid.github.io/FedCM/"><cite>Federated Credential Management API</cite></a>. URL: <a href="https://w3c-fedid.github.io/FedCM/">https://w3c-fedid.github.io/FedCM/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-permissions">[PERMISSIONS]
   <dd>Marcos Caceres; Mike Taylor. <a href="https://w3c.github.io/permissions/"><cite>Permissions</cite></a>. URL: <a href="https://w3c.github.io/permissions/">https://w3c.github.io/permissions/</a>
   <dt id="biblio-permissions-policy-1">[PERMISSIONS-POLICY-1]
   <dd>Ian Clelland. <a href="https://w3c.github.io/webappsec-permissions-policy/"><cite>Permissions Policy</cite></a>. URL: <a href="https://w3c.github.io/webappsec-permissions-policy/">https://w3c.github.io/webappsec-permissions-policy/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc6265">[RFC6265]
   <dd>A. Barth. <a href="https://httpwg.org/specs/rfc6265.html"><cite>HTTP State Management Mechanism</cite></a>. April 2011. Proposed Standard. URL: <a href="https://httpwg.org/specs/rfc6265.html">https://httpwg.org/specs/rfc6265.html</a>
   <dt id="biblio-rfc6265bis">[RFC6265BIS]
   <dd><a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis"><cite>Cookies: HTTP State Management Mechanism</cite></a>. Editor's Draft. URL: <a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis">https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-webdriver">[WebDriver]
   <dd>Simon Stewart; David Burns. <a href="https://w3c.github.io/webdriver/"><cite>WebDriver</cite></a>. URL: <a href="https://w3c.github.io/webdriver/">https://w3c.github.io/webdriver/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-storage-access-intro">[STORAGE-ACCESS-INTRO]
   <dd>John Wilander. <a href="https://webkit.org/blog/8124/introducing-storage-access-api/"><cite>Introducing Storage Access API</cite></a>. February 2018. Blog post. URL: <a href="https://webkit.org/blog/8124/introducing-storage-access-api/">https://webkit.org/blog/8124/introducing-storage-access-api/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-hasstorageaccess"><c- g>hasStorageAccess</c-></a>();
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-document-requeststorageaccess"><c- g>requestStorageAccess</c-></a>();
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> The concept of "ancestry" is being added to HTML in <a href="https://github.com/whatwg/html/pull/11133">https://github.com/whatwg/html/pull/11133</a> <a class="issue-return" href="#issue-ad55531e" title="Jump to section">↵</a></div>
   <div class="issue"> "same authority" here is a placeholder for a future concept that allows user agents to perform <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site">same site</a> checks while adhering to additional security aspects such as the presence of a cross-site parent document, see <a href="https://github.com/whatwg/storage/issues/142#issuecomment-1122147159">whatwg/storage#142</a>. In practice, this might involve comparing the <a data-link-type="dfn" href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-11#section-5.2.1">site for cookies</a> or performing a <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-site">same site</a> check with the top-level document. <a class="issue-return" href="#issue-396d9a1a" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://infra.spec.whatwg.org/#string"},
"07ad3048": {"dfnID":"07ad3048","dfnText":"create navigation params by fetching","external":true,"refSections":[{"refs":[{"id":"ref-for-create-navigation-params-by-fetching"},{"id":"ref-for-create-navigation-params-by-fetching\u2460"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"},
"086e3aff": {"dfnID":"086e3aff","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin"},{"id":"ref-for-concept-origin\u2460"},{"id":"ref-for-concept-origin\u2461"},{"id":"ref-for-concept-origin\u2462"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-origin\u2463"}],"title":"6.1. Permission scope"},{"refs":[{"id":"ref-for-concept-origin\u2464"},{"id":"ref-for-concept-origin\u2465"},{"id":"ref-for-concept-origin\u2466"}],"title":"7. Security considerations"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"0e3ba9f8": {"dfnID":"0e3ba9f8","dfnText":"fully active","external":true,"refSections":[{"refs":[{"id":"ref-for-fully-active"},{"id":"ref-for-fully-active\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"},
"0e5e4e32": {"dfnID":"0e5e4e32","dfnText":"environment","external":true,"refSections":[{"refs":[{"id":"ref-for-environment"},{"id":"ref-for-environment\u2460"},{"id":"ref-for-environment\u2461"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-environment\u2462"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/#environment"},
"0e8de730": {"dfnID":"0e8de730","dfnText":"tuple","external":true,"refSections":[{"refs":[{"id":"ref-for-tuple"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-tuple\u2460"}],"title":"4. Permissions Integration"}],"url":"https://infra.spec.whatwg.org/#tuple"},
"1570624a": {"dfnID":"1570624a","dfnText":"default allowlist","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature-default-allowlist"}],"title":"5. Permissions Policy Integration"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"19353784": {"dfnID":"19353784","dfnText":"cookie store","external":true,"refSections":[{"refs":[{"id":"ref-for-section-5.3"},{"id":"ref-for-section-5.3\u2460"},{"id":"ref-for-section-5.3\u2461"}],"title":"3.5.1. Cookies"}],"url":"https://tools.ietf.org/html/rfc6265#section-5.3"},
"1cdbf0c6": {"dfnID":"1cdbf0c6","dfnText":"connected accounts set","external":true,"refSections":[{"refs":[{"id":"ref-for-browser-connected-accounts-set"}],"title":"3. The Storage Access API"}],"url":"https://w3c-fedid.github.io/FedCM/#browser-connected-accounts-set"},
"27e10eaf": {"dfnID":"27e10eaf","dfnText":"active sandboxing flag set","external":true,"refSections":[{"refs":[{"id":"ref-for-active-sandboxing-flag-set"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"2dfbf26c": {"dfnID":"2dfbf26c","dfnText":"unknown error","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-unknown-error"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error"},
"2f495016": {"dfnID":"2f495016","dfnText":"permission key","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-key"},{"id":"ref-for-dfn-permission-key\u2460"},{"id":"ref-for-dfn-permission-key\u2461"},{"id":"ref-for-dfn-permission-key\u2462"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-key"},
"33438879": {"dfnID":"33438879","dfnText":"getting the current permission state","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-getting-the-current-permission-state"},{"id":"ref-for-dfn-getting-the-current-permission-state\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://w3c.github.io/permissions/#dfn-getting-the-current-permission-state"},
"35972864": {"dfnID":"35972864","dfnText":"active document","external":true,"refSections":[{"refs":[{"id":"ref-for-nav-document"},{"id":"ref-for-nav-document\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-nav-document\u2461"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-nav-document\u2462"}],"title":"3.3. Changes to navigation"},{"refs":[{"id":"ref-for-nav-document\u2463"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-nav-document\u2464"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"3610bd67": {"dfnID":"3610bd67","dfnText":"allowed to use","external":true,"refSections":[{"refs":[{"id":"ref-for-allowed-to-use"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-allowed-to-use\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"36858240": {"dfnID":"36858240","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-boolean"},{"id":"ref-for-boolean\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-boolean\u2461"},{"id":"ref-for-boolean\u2462"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-boolean\u2463"}],"title":"8.1. Set Storage Access"}],"url":"https://infra.spec.whatwg.org/#boolean"},
"3b2ff63e": {"dfnID":"3b2ff63e","dfnText":"browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-bc"},{"id":"ref-for-concept-document-bc\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"3b90bdcd": {"dfnID":"3b90bdcd","dfnText":"resolve","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve"},{"id":"ref-for-resolve\u2460"},{"id":"ref-for-resolve\u2461"},{"id":"ref-for-resolve\u2462"},{"id":"ref-for-resolve\u2463"},{"id":"ref-for-resolve\u2464"},{"id":"ref-for-resolve\u2465"},{"id":"ref-for-resolve\u2466"},{"id":"ref-for-resolve\u2467"},{"id":"ref-for-resolve\u2468"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#resolve"},
"3e12e042": {"dfnID":"3e12e042","dfnText":"environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-environment-settings-object"}],"title":"4. Permissions Integration"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"3f2ca4de": {"dfnID":"3f2ca4de","dfnText":"current URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-current-url"}],"title":"3.4.2. HTTP-redirect-fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-request-current-url"},
"42f00e01": {"dfnID":"42f00e01","dfnText":"snapshotting source snapshot params","external":true,"refSections":[{"refs":[{"id":"ref-for-snapshotting-source-snapshot-params"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-source-snapshot-params"},
"434cbb10": {"dfnID":"434cbb10","dfnText":"credential store","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-credential-store"}],"title":"3. The Storage Access API"}],"url":"https://w3c.github.io/webappsec-credential-management/#concept-credential-store"},
"43ac8374": {"dfnID":"43ac8374","dfnText":"origin (for environment settings object)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-settings-object-origin"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-settings-object-origin\u2460"}],"title":"4. Permissions Integration"},{"refs":[{"id":"ref-for-concept-settings-object-origin\u2461"},{"id":"ref-for-concept-settings-object-origin\u2462"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"457a6f4c": {"dfnID":"457a6f4c","dfnText":"sandboxing flag set","external":true,"refSections":[{"refs":[{"id":"ref-for-sandboxing-flag-set"}],"title":"3.6. Sandboxing storage access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set"},
"45fae3a4": {"dfnID":"45fae3a4","dfnText":"ancestry","external":true,"refSections":[{"refs":[{"id":"ref-for-TODO"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://html.spec.whatwg.org/multipage/#TODO"},
"47fe679e": {"dfnID":"47fe679e","dfnText":"transient activation","external":true,"refSections":[{"refs":[{"id":"ref-for-transient-activation"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"48438eb3": {"dfnID":"48438eb3","dfnText":"queue a global task","external":true,"refSections":[{"refs":[{"id":"ref-for-queue-a-global-task"},{"id":"ref-for-queue-a-global-task\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"48968b5b": {"dfnID":"48968b5b","dfnText":"invalid argument","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-invalid-argument"},{"id":"ref-for-dfn-invalid-argument\u2460"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument"},
"5372cca8": {"dfnID":"5372cca8","dfnText":"boolean","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-boolean"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"53f0ea4e": {"dfnID":"53f0ea4e","dfnText":"parse a sandboxing directive","external":true,"refSections":[{"refs":[{"id":"ref-for-parse-a-sandboxing-directive"}],"title":"3.6. Sandboxing storage access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive"},
"55213b5b": {"dfnID":"55213b5b","dfnText":"request","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request"},{"id":"ref-for-concept-request\u2460"},{"id":"ref-for-concept-request\u2461"},{"id":"ref-for-concept-request\u2462"},{"id":"ref-for-concept-request\u2463"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-concept-request\u2464"},{"id":"ref-for-concept-request\u2465"},{"id":"ref-for-concept-request\u2466"}],"title":"3.5.1. Cookies"}],"url":"https://fetch.spec.whatwg.org/#concept-request"},
"5661b7f6": {"dfnID":"5661b7f6","dfnText":"remote end steps","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-remote-end-steps"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps"},
"5a330bbb": {"dfnID":"5a330bbb","dfnText":"has-cross-origin-redirects","external":true,"refSections":[{"refs":[{"id":"ref-for-response-has-cross-origin-redirects"}],"title":"3.3. Changes to navigation"}],"url":"https://fetch.spec.whatwg.org/#response-has-cross-origin-redirects"},
"5d7209e9": {"dfnID":"5d7209e9","dfnText":"Window","external":true,"refSections":[{"refs":[{"id":"ref-for-window"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"5f90bbfb": {"dfnID":"5f90bbfb","dfnText":"undefined","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-undefined"},{"id":"ref-for-idl-undefined\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"602b1a68": {"dfnID":"602b1a68","dfnText":"obtain a site","external":true,"refSections":[{"refs":[{"id":"ref-for-obtain-a-site"},{"id":"ref-for-obtain-a-site\u2460"},{"id":"ref-for-obtain-a-site\u2461"},{"id":"ref-for-obtain-a-site\u2462"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-obtain-a-site\u2463"},{"id":"ref-for-obtain-a-site\u2464"}],"title":"4. Permissions Integration"},{"refs":[{"id":"ref-for-obtain-a-site\u2465"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"620f832e": {"dfnID":"620f832e","dfnText":"state","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissionstatus-state"},{"id":"ref-for-dom-permissionstatus-state\u2460"},{"id":"ref-for-dom-permissionstatus-state\u2461"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dom-permissionstatus-state"},
"64eb4e66": {"dfnID":"64eb4e66","dfnText":"extension command","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-extension-commands"}],"title":"8. Automation"},{"refs":[{"id":"ref-for-dfn-extension-commands\u2460"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands"},
"65181da8": {"dfnID":"65181da8","dfnText":"secure context","external":true,"refSections":[{"refs":[{"id":"ref-for-secure-context"},{"id":"ref-for-secure-context\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-secure-context\u2461"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-secure-context\u2462"}],"title":"7.1. Reputational attacks"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context"},
"66f104fd": {"dfnID":"66f104fd","dfnText":"set up a window environment settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-set-up-a-window-environment-settings-object"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#set-up-a-window-environment-settings-object"},
"6821ab89": {"dfnID":"6821ab89","dfnText":"granted","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-granted"},{"id":"ref-for-dfn-granted\u2460"},{"id":"ref-for-dfn-granted\u2461"},{"id":"ref-for-dfn-granted\u2462"},{"id":"ref-for-dfn-granted\u2463"},{"id":"ref-for-dfn-granted\u2464"}],"title":"3.2. Changes to Document"}],"url":"https://w3c.github.io/permissions/#dfn-granted"},
"6c2d7879": {"dfnID":"6c2d7879","dfnText":"powerful feature","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-powerful-feature"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-powerful-feature"},
"6d19ac93": {"dfnID":"6d19ac93","dfnText":"user agent","external":true,"refSections":[{"refs":[{"id":"ref-for-user-agent"}],"title":"3. The Storage Access API"}],"url":"https://infra.spec.whatwg.org/#user-agent"},
"7393da89": {"dfnID":"7393da89","dfnText":"same origin","external":true,"refSections":[{"refs":[{"id":"ref-for-same-origin"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-same-origin\u2460"}],"title":"3.3. Changes to navigation"},{"refs":[{"id":"ref-for-same-origin\u2461"}],"title":"3.4.2. HTTP-redirect-fetch"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"73a186aa": {"dfnID":"73a186aa","dfnText":"id","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-environment-id"},{"id":"ref-for-concept-environment-id\u2460"}],"title":"3.3. Changes to navigation"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id"},
"77093875": {"dfnID":"77093875","dfnText":"source snapshot params","external":true,"refSections":[{"refs":[{"id":"ref-for-source-snapshot-params"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params"},
"77b4c09a": {"dfnID":"77b4c09a","dfnText":"assert","external":true,"refSections":[{"refs":[{"id":"ref-for-assert"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-assert\u2460"},{"id":"ref-for-assert\u2461"}],"title":"3.2. Changes to Document"}],"url":"https://infra.spec.whatwg.org/#assert"},
"797018a7": {"dfnID":"797018a7","dfnText":"InvalidStateError","external":true,"refSections":[{"refs":[{"id":"ref-for-invalidstateerror"},{"id":"ref-for-invalidstateerror\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#invalidstateerror"},
"79bfe9df": {"dfnID":"79bfe9df","dfnText":"permission key type","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-key-type"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-key-type"},
"7ee1f942": {"dfnID":"7ee1f942","dfnText":"permission query algorithm","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-query-algorithm"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-query-algorithm"},
"85394472": {"dfnID":"85394472","dfnText":"Document","external":true,"refSections":[{"refs":[{"id":"ref-for-document"},{"id":"ref-for-document\u2460"},{"id":"ref-for-document\u2461"},{"id":"ref-for-document\u2462"},{"id":"ref-for-document\u2463"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-document\u2464"},{"id":"ref-for-document\u2465"},{"id":"ref-for-document\u2466"},{"id":"ref-for-document\u2467"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-document\u2468"}],"title":"5. Permissions Policy Integration"},{"refs":[{"id":"ref-for-document\u2460\u24ea"},{"id":"ref-for-document\u2460\u2460"},{"id":"ref-for-document\u2460\u2461"},{"id":"ref-for-document\u2460\u2462"},{"id":"ref-for-document\u2460\u2463"},{"id":"ref-for-document\u2460\u2464"},{"id":"ref-for-document\u2460\u2465"},{"id":"ref-for-document\u2460\u2466"},{"id":"ref-for-document\u2460\u2467"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-document\u2460\u2468"}],"title":"6.1. Permission scope"},{"refs":[{"id":"ref-for-document\u2461\u24ea"},{"id":"ref-for-document\u2461\u2460"}],"title":"7. Security considerations"},{"refs":[{"id":"ref-for-document\u2461\u2461"},{"id":"ref-for-document\u2461\u2462"}],"title":"7.1. Reputational attacks"},{"refs":[{"id":"ref-for-document\u2461\u2463"}],"title":"7.2. Notification abuse"}],"url":"https://dom.spec.whatwg.org/#document"},
"857d5516": {"dfnID":"857d5516","dfnText":"client","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-client"},{"id":"ref-for-concept-request-client\u2460"},{"id":"ref-for-concept-request-client\u2461"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"860300d4": {"dfnID":"860300d4","dfnText":"implementation-defined","external":true,"refSections":[{"refs":[{"id":"ref-for-implementation-defined"},{"id":"ref-for-implementation-defined\u2460"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-implementation-defined\u2461"},{"id":"ref-for-implementation-defined\u2462"},{"id":"ref-for-implementation-defined\u2463"},{"id":"ref-for-implementation-defined\u2464"},{"id":"ref-for-implementation-defined\u2465"}],"title":"8.1. Set Storage Access"}],"url":"https://infra.spec.whatwg.org/#implementation-defined"},
"87b50d92": {"dfnID":"87b50d92","dfnText":"unsupported operation","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-unsupported-operation"},{"id":"ref-for-dfn-unsupported-operation\u2460"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation"},
"87fcd40c": {"dfnID":"87fcd40c","dfnText":"iframe","external":true,"refSections":[{"refs":[{"id":"ref-for-the-iframe-element"},{"id":"ref-for-the-iframe-element\u2460"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-the-iframe-element\u2461"},{"id":"ref-for-the-iframe-element\u2462"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-the-iframe-element\u2463"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"8acee9c8": {"dfnID":"8acee9c8","dfnText":"http-redirect fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-http-redirect-fetch"}],"title":"3.4.2. HTTP-redirect-fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch"},
"951ae231": {"dfnID":"951ae231","dfnText":"permission key generation algorithm","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-key-generation-algorithm"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-key-generation-algorithm"},
"959ad97b": {"dfnID":"959ad97b","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-origin"},{"id":"ref-for-concept-url-origin\u2460"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-concept-url-origin\u2461"},{"id":"ref-for-concept-url-origin\u2462"}],"title":"3.3. Changes to navigation"},{"refs":[{"id":"ref-for-concept-url-origin\u2463"},{"id":"ref-for-concept-url-origin\u2464"}],"title":"3.4.2. HTTP-redirect-fetch"},{"refs":[{"id":"ref-for-concept-url-origin\u2465"}],"title":"8.1. Set Storage Access"}],"url":"https://url.spec.whatwg.org/#concept-url-origin"},
"980528b0": {"dfnID":"980528b0","dfnText":"http-network-or-cache fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-http-network-or-cache-fetch"},{"id":"ref-for-concept-http-network-or-cache-fetch\u2460"}],"title":"3.5.1. Cookies"}],"url":"https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch"},
"986c69cd": {"dfnID":"986c69cd","dfnText":"success","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-success"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success"},
"991d0ba3": {"dfnID":"991d0ba3","dfnText":"WebDriver error","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-error"},{"id":"ref-for-dfn-error\u2460"},{"id":"ref-for-dfn-error\u2461"},{"id":"ref-for-dfn-error\u2462"},{"id":"ref-for-dfn-error\u2463"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error"},
"9c4c1e66": {"dfnID":"9c4c1e66","dfnText":"relevant settings object","external":true,"refSections":[{"refs":[{"id":"ref-for-relevant-settings-object"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-relevant-settings-object\u2460"},{"id":"ref-for-relevant-settings-object\u2461"},{"id":"ref-for-relevant-settings-object\u2462"},{"id":"ref-for-relevant-settings-object\u2463"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-relevant-settings-object\u2464"},{"id":"ref-for-relevant-settings-object\u2465"}],"title":"3.3. Changes to navigation"},{"refs":[{"id":"ref-for-relevant-settings-object\u2466"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"a1e6e861": {"dfnID":"a1e6e861","dfnText":"cookie","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-document-cookie"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-dom-document-cookie\u2460"},{"id":"ref-for-dom-document-cookie\u2461"}],"title":"3.5.1. Cookies"}],"url":"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie"},
"a33db89a": {"dfnID":"a33db89a","dfnText":"fetch","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-fetch"}],"title":"3.4.1. Fetching"}],"url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"a41102eb": {"dfnID":"a41102eb","dfnText":"permissions policy","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-permissions-policy"}],"title":"5. Permissions Policy Integration"}],"url":"https://html.spec.whatwg.org/multipage/dom.html#concept-document-permissions-policy"},
"a72449dd": {"dfnID":"a72449dd","dfnText":"in parallel","external":true,"refSections":[{"refs":[{"id":"ref-for-in-parallel"},{"id":"ref-for-in-parallel\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"a98e2e2c": {"dfnID":"a98e2e2c","dfnText":"permission key comparison algorithm","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-key-comparison-algorithm"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-key-comparison-algorithm"},
"abe352cd": {"dfnID":"abe352cd","dfnText":"reserved client","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-reserved-client"},{"id":"ref-for-concept-request-reserved-client\u2460"},{"id":"ref-for-concept-request-reserved-client\u2461"}],"title":"3.3. Changes to navigation"}],"url":"https://fetch.spec.whatwg.org/#concept-request-reserved-client"},
"aca22383": {"dfnID":"aca22383","dfnText":"consume user activation","external":true,"refSections":[{"refs":[{"id":"ref-for-consume-user-activation"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation"},
"ae2a6342": {"dfnID":"ae2a6342","dfnText":"top-level browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-top-level-browsing-context"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2460"},{"id":"ref-for-top-level-browsing-context\u2461"},{"id":"ref-for-top-level-browsing-context\u2462"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2463"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-top-level-browsing-context\u2464"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"ae66758d": {"dfnID":"ae66758d","dfnText":"getting a property","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-getting-properties"},{"id":"ref-for-dfn-getting-properties\u2460"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties"},
"attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation": {"dfnID":"attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation","dfnText":"allow-storage-access-by-user-activation","external":false,"refSections":[],"url":"#attr-valuedef-iframe-sandbox-allow-storage-access-by-user-activation"},
"b01b1359": {"dfnID":"b01b1359","dfnText":"opaque origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-opaque"},{"id":"ref-for-concept-origin-opaque\u2460"},{"id":"ref-for-concept-origin-opaque\u2461"},{"id":"ref-for-concept-origin-opaque\u2462"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"b262501e": {"dfnID":"b262501e","dfnText":"reject","external":true,"refSections":[{"refs":[{"id":"ref-for-reject"},{"id":"ref-for-reject\u2460"},{"id":"ref-for-reject\u2461"},{"id":"ref-for-reject\u2462"},{"id":"ref-for-reject\u2463"},{"id":"ref-for-reject\u2464"},{"id":"ref-for-reject\u2465"},{"id":"ref-for-reject\u2466"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#reject"},
"b2915302": {"dfnID":"b2915302","dfnText":"prompt","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-prompt"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dfn-prompt\u2460"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-prompt"},
"b6ae4501": {"dfnID":"b6ae4501","dfnText":"networking task source","external":true,"refSections":[{"refs":[{"id":"ref-for-networking-task-source"},{"id":"ref-for-networking-task-source\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source"},
"b8623307": {"dfnID":"b8623307","dfnText":"site for cookies","external":true,"refSections":[{"refs":[{"id":"ref-for-section-5.2.1"}],"title":"3.2. Changes to Document"}],"url":"https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-11#section-5.2.1"},
"ba556545": {"dfnID":"ba556545","dfnText":"NotAllowedError","external":true,"refSections":[{"refs":[{"id":"ref-for-notallowederror"},{"id":"ref-for-notallowederror\u2460"},{"id":"ref-for-notallowederror\u2461"},{"id":"ref-for-notallowederror\u2462"},{"id":"ref-for-notallowederror\u2463"},{"id":"ref-for-notallowederror\u2464"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#notallowederror"},
"bdbd19d1": {"dfnID":"bdbd19d1","dfnText":"Promise","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-promise"},{"id":"ref-for-idl-promise\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-idl-promise\u2461"}],"title":"6. Privacy considerations"}],"url":"https://webidl.spec.whatwg.org/#idl-promise"},
"c45850fd": {"dfnID":"c45850fd","dfnText":"WebDriver error code","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-error-code"},{"id":"ref-for-dfn-error-code\u2460"},{"id":"ref-for-dfn-error-code\u2461"},{"id":"ref-for-dfn-error-code\u2462"},{"id":"ref-for-dfn-error-code\u2463"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code"},
"c62cd7cf": {"dfnID":"c62cd7cf","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-document-origin"},{"id":"ref-for-concept-document-origin\u2460"},{"id":"ref-for-concept-document-origin\u2461"},{"id":"ref-for-concept-document-origin\u2462"}],"title":"3.2. Changes to Document"}],"url":"https://dom.spec.whatwg.org/#concept-document-origin"},
"c63519ed": {"dfnID":"c63519ed","dfnText":"top-level origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-environment-top-level-origin"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-concept-environment-top-level-origin\u2460"},{"id":"ref-for-concept-environment-top-level-origin\u2461"},{"id":"ref-for-concept-environment-top-level-origin\u2462"},{"id":"ref-for-concept-environment-top-level-origin\u2463"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-concept-environment-top-level-origin\u2464"}],"title":"4. Permissions Integration"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"c7141347": {"dfnID":"c7141347","dfnText":"Should request be allowed to use feature?","external":true,"refSections":[{"refs":[{"id":"ref-for-should-request-be-allowed-to-use-feature"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#should-request-be-allowed-to-use-feature"},
"ca3ca4ae": {"dfnID":"ca3ca4ae","dfnText":"URL parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-parser"}],"title":"8.1. Set Storage Access"}],"url":"https://url.spec.whatwg.org/#concept-url-parser"},
"cc890cc1": {"dfnID":"cc890cc1","dfnText":"policy-controlled feature","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-controlled-feature"}],"title":"5. Permissions Policy Integration"}],"url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"d124397f": {"dfnID":"d124397f","dfnText":"permission state","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-permission-state"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dfn-permission-state\u2460"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-permission-state"},
"d357c753": {"dfnID":"d357c753","dfnText":"requesting permission to use","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-request-permission-to-use"}],"title":"3.2. Changes to Document"}],"url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"d695a1e4": {"dfnID":"d695a1e4","dfnText":"current browsing context","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-current-browsing-context"},{"id":"ref-for-dfn-current-browsing-context\u2460"},{"id":"ref-for-dfn-current-browsing-context\u2461"}],"title":"8.1. Set Storage Access"}],"url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context"},
"dacde8b5": {"dfnID":"dacde8b5","dfnText":"a new promise","external":true,"refSections":[{"refs":[{"id":"ref-for-a-new-promise"},{"id":"ref-for-a-new-promise\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"dbf8e074": {"dfnID":"dbf8e074","dfnText":"PermissionStatus","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissionstatus"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dom-permissionstatus"},
"dc1cd39b": {"dfnID":"dc1cd39b","dfnText":"URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-url"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"dca2de17": {"dfnID":"dca2de17","dfnText":"DOMException","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMException"},{"id":"ref-for-idl-DOMException\u2460"},{"id":"ref-for-idl-DOMException\u2461"},{"id":"ref-for-idl-DOMException\u2462"},{"id":"ref-for-idl-DOMException\u2463"},{"id":"ref-for-idl-DOMException\u2464"},{"id":"ref-for-idl-DOMException\u2465"},{"id":"ref-for-idl-DOMException\u2466"}],"title":"3.2. Changes to Document"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"determine-the-effective-fedcm-connection-status": {"dfnID":"determine-the-effective-fedcm-connection-status","dfnText":"determine the effective FedCM connection status","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-the-effective-fedcm-connection-status"}],"title":"3.2. Changes to Document"}],"url":"#determine-the-effective-fedcm-connection-status"},
"determine-the-fedcm-site-connection-status": {"dfnID":"determine-the-fedcm-site-connection-status","dfnText":"determine the FedCM site connection status","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-the-fedcm-site-connection-status"}],"title":"3. The Storage Access API"}],"url":"#determine-the-fedcm-site-connection-status"},
"determine-the-initial-storage-access-eligibility": {"dfnID":"determine-the-initial-storage-access-eligibility","dfnText":"determine the initial storage-access eligibility","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-the-initial-storage-access-eligibility"}],"title":"3.4.1. Fetching"}],"url":"#determine-the-initial-storage-access-eligibility"},
"determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access": {"dfnID":"determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access","dfnText":"determine whether the user agent explicitly allows unpartitioned cookie access","external":false,"refSections":[{"refs":[{"id":"ref-for-determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access"},{"id":"ref-for-determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access\u2460"}],"title":"3.2. Changes to Document"}],"url":"#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access"},
"dom-document-hasstorageaccess": {"dfnID":"dom-document-hasstorageaccess","dfnText":"hasStorageAccess()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-hasstorageaccess"},{"id":"ref-for-dom-document-hasstorageaccess\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-dom-document-hasstorageaccess\u2461"}],"title":"3.2. Changes to Document"}],"url":"#dom-document-hasstorageaccess"},
"dom-document-requeststorageaccess": {"dfnID":"dom-document-requeststorageaccess","dfnText":"requestStorageAccess()","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-document-requeststorageaccess"},{"id":"ref-for-dom-document-requeststorageaccess\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2461"},{"id":"ref-for-dom-document-requeststorageaccess\u2462"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2463"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2464"},{"id":"ref-for-dom-document-requeststorageaccess\u2465"}],"title":"5. Permissions Policy Integration"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2466"},{"id":"ref-for-dom-document-requeststorageaccess\u2467"},{"id":"ref-for-dom-document-requeststorageaccess\u2468"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-dom-document-requeststorageaccess\u2460\u24ea"},{"id":"ref-for-dom-document-requeststorageaccess\u2460\u2460"}],"title":"7. Security considerations"}],"url":"#dom-document-requeststorageaccess"},
"e740d7e5": {"dfnID":"e740d7e5","dfnText":"name","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-name"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-name"},
"e99bd18e": {"dfnID":"e99bd18e","dfnText":"relevant global object","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-relevant-global"},{"id":"ref-for-concept-relevant-global\u2460"}],"title":"3.2. Changes to Document"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"ebb01253": {"dfnID":"ebb01253","dfnText":"PermissionDescriptor","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-permissiondescriptor"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dom-permissiondescriptor"},
"environment-has-storage-access": {"dfnID":"environment-has-storage-access","dfnText":"has storage access","external":false,"refSections":[{"refs":[{"id":"ref-for-environment-has-storage-access"},{"id":"ref-for-environment-has-storage-access\u2460"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-environment-has-storage-access\u2461"},{"id":"ref-for-environment-has-storage-access\u2462"},{"id":"ref-for-environment-has-storage-access\u2463"},{"id":"ref-for-environment-has-storage-access\u2464"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-environment-has-storage-access\u2465"},{"id":"ref-for-environment-has-storage-access\u2466"},{"id":"ref-for-environment-has-storage-access\u2467"},{"id":"ref-for-environment-has-storage-access\u2468"}],"title":"3.3. Changes to navigation"}],"url":"#environment-has-storage-access"},
"f02cd417": {"dfnID":"f02cd417","dfnText":"iterate","external":true,"refSections":[{"refs":[{"id":"ref-for-list-iterate"}],"title":"3. The Storage Access API"}],"url":"https://infra.spec.whatwg.org/#list-iterate"},
"f0482ed2": {"dfnID":"f0482ed2","dfnText":"same site (for site)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-site-same-site"},{"id":"ref-for-concept-site-same-site\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-concept-site-same-site\u2461"},{"id":"ref-for-concept-site-same-site\u2462"}],"title":"4. Permissions Integration"},{"refs":[{"id":"ref-for-concept-site-same-site\u2463"}],"title":"6.1. Permission scope"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site"},
"f52ea2e1": {"dfnID":"f52ea2e1","dfnText":"prevent silent access flag","external":true,"refSections":[{"refs":[{"id":"ref-for-origin-prevent-silent-access-flag"}],"title":"3. The Storage Access API"}],"url":"https://w3c.github.io/webappsec-credential-management/#origin-prevent-silent-access-flag"},
"fb4878d7": {"dfnID":"fb4878d7","dfnText":"denied","external":true,"refSections":[{"refs":[{"id":"ref-for-dfn-denied"},{"id":"ref-for-dfn-denied\u2460"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-dfn-denied\u2461"}],"title":"4. Permissions Integration"}],"url":"https://w3c.github.io/permissions/#dfn-denied"},
"fb9bb722": {"dfnID":"fb9bb722","dfnText":"site","external":true,"refSections":[{"refs":[{"id":"ref-for-site"},{"id":"ref-for-site\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-site\u2461"},{"id":"ref-for-site\u2462"}],"title":"4. Permissions Integration"},{"refs":[{"id":"ref-for-site\u2463"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-site\u2464"},{"id":"ref-for-site\u2465"}],"title":"6.1. Permission scope"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"feac4ab3": {"dfnID":"feac4ab3","dfnText":"same site","external":true,"refSections":[{"refs":[{"id":"ref-for-same-site"},{"id":"ref-for-same-site\u2460"},{"id":"ref-for-same-site\u2461"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-same-site\u2462"},{"id":"ref-for-same-site\u2463"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-same-site\u2464"}],"title":"8.1. Set Storage Access"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#same-site"},
"first-party-site-context": {"dfnID":"first-party-site-context","dfnText":"first-party-site context","external":false,"refSections":[{"refs":[{"id":"ref-for-first-party-site-context"},{"id":"ref-for-first-party-site-context\u2460"},{"id":"ref-for-first-party-site-context\u2461"},{"id":"ref-for-first-party-site-context\u2462"}],"title":"3. The Storage Access API"}],"url":"#first-party-site-context"},
"permission-key-requester": {"dfnID":"permission-key-requester","dfnText":"requester","external":false,"refSections":[{"refs":[{"id":"ref-for-permission-key-requester"},{"id":"ref-for-permission-key-requester\u2460"},{"id":"ref-for-permission-key-requester\u2461"}],"title":"4. Permissions Integration"}],"url":"#permission-key-requester"},
"permission-key-top-level": {"dfnID":"permission-key-top-level","dfnText":"top-level","external":false,"refSections":[{"refs":[{"id":"ref-for-permission-key-top-level"},{"id":"ref-for-permission-key-top-level\u2460"},{"id":"ref-for-permission-key-top-level\u2461"}],"title":"4. Permissions Integration"}],"url":"#permission-key-top-level"},
"permissiondef-storage-access": {"dfnID":"permissiondef-storage-access","dfnText":"storage-access","external":false,"refSections":[{"refs":[{"id":"ref-for-permissiondef-storage-access"},{"id":"ref-for-permissiondef-storage-access\u2460"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-permissiondef-storage-access\u2461"},{"id":"ref-for-permissiondef-storage-access\u2462"},{"id":"ref-for-permissiondef-storage-access\u2463"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-permissiondef-storage-access\u2464"},{"id":"ref-for-permissiondef-storage-access\u2465"},{"id":"ref-for-permissiondef-storage-access\u2466"},{"id":"ref-for-permissiondef-storage-access\u2467"},{"id":"ref-for-permissiondef-storage-access\u2468"}],"title":"4. Permissions Integration"}],"url":"#permissiondef-storage-access"},
"request-eligible-for-storage-access": {"dfnID":"request-eligible-for-storage-access","dfnText":"eligible for storage-access","external":false,"refSections":[{"refs":[{"id":"ref-for-request-eligible-for-storage-access"}],"title":"3.4.1. Fetching"},{"refs":[{"id":"ref-for-request-eligible-for-storage-access\u2460"},{"id":"ref-for-request-eligible-for-storage-access\u2461"}],"title":"3.4.2. HTTP-redirect-fetch"},{"refs":[{"id":"ref-for-request-eligible-for-storage-access\u2462"},{"id":"ref-for-request-eligible-for-storage-access\u2463"}],"title":"3.5.1. Cookies"}],"url":"#request-eligible-for-storage-access"},
"sandbox-storage-access-by-user-activation-flag": {"dfnID":"sandbox-storage-access-by-user-activation-flag","dfnText":"sandbox storage access by user activation flag","external":false,"refSections":[{"refs":[{"id":"ref-for-sandbox-storage-access-by-user-activation-flag"}],"title":"3.2. Changes to Document"},{"refs":[{"id":"ref-for-sandbox-storage-access-by-user-activation-flag\u2460"}],"title":"3.6. Sandboxing storage access"}],"url":"#sandbox-storage-access-by-user-activation-flag"},
"set-storage-access": {"dfnID":"set-storage-access","dfnText":"Set Storage Access","external":false,"refSections":[],"url":"#set-storage-access"},
"source-snapshot-params-environment-id": {"dfnID":"source-snapshot-params-environment-id","dfnText":"environment id","external":false,"refSections":[{"refs":[{"id":"ref-for-source-snapshot-params-environment-id"},{"id":"ref-for-source-snapshot-params-environment-id\u2460"}],"title":"3.3. Changes to navigation"}],"url":"#source-snapshot-params-environment-id"},
"source-snapshot-params-has-storage-access": {"dfnID":"source-snapshot-params-has-storage-access","dfnText":"has storage access","external":false,"refSections":[{"refs":[{"id":"ref-for-source-snapshot-params-has-storage-access"},{"id":"ref-for-source-snapshot-params-has-storage-access\u2460"},{"id":"ref-for-source-snapshot-params-has-storage-access\u2461"}],"title":"3.3. Changes to navigation"}],"url":"#source-snapshot-params-has-storage-access"},
"storage-access-eligibility": {"dfnID":"storage-access-eligibility","dfnText":"storage access eligibility","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-eligibility"},{"id":"ref-for-storage-access-eligibility\u2460"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"#storage-access-eligibility"},
"storage-access-eligibility-eligible": {"dfnID":"storage-access-eligibility-eligible","dfnText":"eligible","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-eligibility-eligible"}],"title":"3.1. Changes to user agent state related to storage access"}],"url":"#storage-access-eligibility-eligible"},
"storage-access-eligibility-ineligible": {"dfnID":"storage-access-eligibility-ineligible","dfnText":"ineligible","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-eligibility-ineligible"},{"id":"ref-for-storage-access-eligibility-ineligible\u2460"},{"id":"ref-for-storage-access-eligibility-ineligible\u2461"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-storage-access-eligibility-ineligible\u2462"}],"title":"3.4.2. HTTP-redirect-fetch"}],"url":"#storage-access-eligibility-ineligible"},
"storage-access-eligibility-unset": {"dfnID":"storage-access-eligibility-unset","dfnText":"unset","external":false,"refSections":[{"refs":[{"id":"ref-for-storage-access-eligibility-unset"},{"id":"ref-for-storage-access-eligibility-unset\u2460"},{"id":"ref-for-storage-access-eligibility-unset\u2461"}],"title":"3.1. Changes to user agent state related to storage access"},{"refs":[{"id":"ref-for-storage-access-eligibility-unset\u2462"}],"title":"3.4.2. HTTP-redirect-fetch"}],"url":"#storage-access-eligibility-unset"},
"third-party-context": {"dfnID":"third-party-context","dfnText":"third party context","external":false,"refSections":[{"refs":[{"id":"ref-for-third-party-context"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-third-party-context\u2460"},{"id":"ref-for-third-party-context\u2461"}],"title":"3.5.1. Cookies"},{"refs":[{"id":"ref-for-third-party-context\u2462"},{"id":"ref-for-third-party-context\u2463"},{"id":"ref-for-third-party-context\u2464"},{"id":"ref-for-third-party-context\u2465"}],"title":"8.1. Set Storage Access"}],"url":"#third-party-context"},
"unpartitioned-data": {"dfnID":"unpartitioned-data","dfnText":"Unpartitioned data","external":false,"refSections":[{"refs":[{"id":"ref-for-unpartitioned-data"},{"id":"ref-for-unpartitioned-data\u2460"}],"title":"3. The Storage Access API"},{"refs":[{"id":"ref-for-unpartitioned-data\u2461"},{"id":"ref-for-unpartitioned-data\u2462"},{"id":"ref-for-unpartitioned-data\u2463"}],"title":"6. Privacy considerations"},{"refs":[{"id":"ref-for-unpartitioned-data\u2464"}],"title":"7. Security considerations"},{"refs":[{"id":"ref-for-unpartitioned-data\u2465"},{"id":"ref-for-unpartitioned-data\u2466"},{"id":"ref-for-unpartitioned-data\u2467"},{"id":"ref-for-unpartitioned-data\u2468"}],"title":"8.1. Set Storage Access"}],"url":"#unpartitioned-data"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#determine-the-effective-fedcm-connection-status": {"displayText":"determine the effective fedcm connection status","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine the effective fedcm connection status","type":"dfn","url":"#determine-the-effective-fedcm-connection-status"},
"#determine-the-fedcm-site-connection-status": {"displayText":"determine the fedcm site connection status","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine the fedcm site connection status","type":"dfn","url":"#determine-the-fedcm-site-connection-status"},
"#determine-the-initial-storage-access-eligibility": {"displayText":"determine the initial storage-access eligibility","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine the initial storage-access eligibility","type":"dfn","url":"#determine-the-initial-storage-access-eligibility"},
"#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access": {"displayText":"determine whether the user agent explicitly allows unpartitioned cookie access","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"determine whether the user agent explicitly allows unpartitioned cookie access","type":"dfn","url":"#determine-whether-the-user-agent-explicitly-allows-unpartitioned-cookie-access"},
"#dom-document-hasstorageaccess": {"displayText":"hasStorageAccess()","export":true,"for_":["Document"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"hasStorageAccess()","type":"method","url":"#dom-document-hasstorageaccess"},
"#dom-document-requeststorageaccess": {"displayText":"requestStorageAccess()","export":true,"for_":["Document"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"requestStorageAccess()","type":"method","url":"#dom-document-requeststorageaccess"},
"#environment-has-storage-access": {"displayText":"has storage access","export":true,"for_":["environment"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"has storage access","type":"dfn","url":"#environment-has-storage-access"},
"#first-party-site-context": {"displayText":"first-party-site context","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"first-party-site context","type":"dfn","url":"#first-party-site-context"},
"#permission-key-requester": {"displayText":"requester","export":true,"for_":["permission key"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"requester","type":"dfn","url":"#permission-key-requester"},
"#permission-key-top-level": {"displayText":"top-level","export":true,"for_":["permission key"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"top-level","type":"dfn","url":"#permission-key-top-level"},
"#permissiondef-storage-access": {"displayText":"storage-access","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"storage-access","type":"permission","url":"#permissiondef-storage-access"},
"#request-eligible-for-storage-access": {"displayText":"eligible for storage-access","export":true,"for_":["request"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"eligible for storage-access","type":"dfn","url":"#request-eligible-for-storage-access"},
"#sandbox-storage-access-by-user-activation-flag": {"displayText":"sandbox storage access by user activation flag","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"sandbox storage access by user activation flag","type":"dfn","url":"#sandbox-storage-access-by-user-activation-flag"},
"#source-snapshot-params-environment-id": {"displayText":"environment id","export":true,"for_":["source snapshot params"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"environment id","type":"dfn","url":"#source-snapshot-params-environment-id"},
"#source-snapshot-params-has-storage-access": {"displayText":"has storage access","export":true,"for_":["source snapshot params"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"has storage access","type":"dfn","url":"#source-snapshot-params-has-storage-access"},
"#storage-access-eligibility": {"displayText":"storage access eligibility","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"storage access eligibility","type":"dfn","url":"#storage-access-eligibility"},
"#storage-access-eligibility-eligible": {"displayText":"eligible","export":true,"for_":["storage access eligibility"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"eligible","type":"dfn","url":"#storage-access-eligibility-eligible"},
"#storage-access-eligibility-ineligible": {"displayText":"ineligible","export":true,"for_":["storage access eligibility"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"ineligible","type":"dfn","url":"#storage-access-eligibility-ineligible"},
"#storage-access-eligibility-unset": {"displayText":"unset","export":true,"for_":["storage access eligibility"],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"unset","type":"dfn","url":"#storage-access-eligibility-unset"},
"#third-party-context": {"displayText":"third party context","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"third party context","type":"dfn","url":"#third-party-context"},
"#unpartitioned-data": {"displayText":"unpartitioned data","export":true,"for_":[],"level":"","normative":true,"shortname":"storage-access","spec":"storage-access","status":"local","text":"unpartitioned data","type":"dfn","url":"#unpartitioned-data"},
"https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-11#section-5.2.1": {"displayText":"site for cookies","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6265bis","spec":"rfc6265bis","status":"anchor-block","text":"site for cookies","type":"dfn","url":"https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis-11#section-5.2.1"},
"https://dom.spec.whatwg.org/#concept-document-origin": {"displayText":"origin","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"origin","type":"dfn","url":"https://dom.spec.whatwg.org/#concept-document-origin"},
"https://dom.spec.whatwg.org/#document": {"displayText":"Document","export":true,"for_":[],"level":"1","normative":true,"shortname":"dom","spec":"dom","status":"current","text":"Document","type":"interface","url":"https://dom.spec.whatwg.org/#document"},
"https://fetch.spec.whatwg.org/#concept-fetch": {"displayText":"fetch","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-fetch"},
"https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch": {"displayText":"http-network-or-cache fetch","export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"http-network-or-cache fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-http-network-or-cache-fetch"},
"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch": {"displayText":"http-redirect fetch","export":true,"for_":[],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"http-redirect fetch","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-http-redirect-fetch"},
"https://fetch.spec.whatwg.org/#concept-request": {"displayText":"request","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"request","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request"},
"https://fetch.spec.whatwg.org/#concept-request-client": {"displayText":"client","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"client","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"https://fetch.spec.whatwg.org/#concept-request-current-url": {"displayText":"current URL","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"current url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-current-url"},
"https://fetch.spec.whatwg.org/#concept-request-reserved-client": {"displayText":"reserved client","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"reserved client","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-reserved-client"},
"https://fetch.spec.whatwg.org/#concept-request-url": {"displayText":"URL","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"https://fetch.spec.whatwg.org/#response-has-cross-origin-redirects": {"displayText":"has-cross-origin-redirects","export":true,"for_":["response"],"level":"","normative":true,"shortname":"fetch","spec":"fetch","status":"anchor-block","text":"has-cross-origin-redirects","type":"dfn","url":"https://fetch.spec.whatwg.org/#response-has-cross-origin-redirects"},
"https://html.spec.whatwg.org/multipage/#TODO": {"displayText":"ancestry","export":true,"for_":["environment"],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"ancestry","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#TODO"},
"https://html.spec.whatwg.org/multipage/#environment": {"displayText":"environment","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"environment","type":"dfn","url":"https://html.spec.whatwg.org/multipage/#environment"},
"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set": {"displayText":"active sandboxing flag set","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active sandboxing flag set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#active-sandboxing-flag-set"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin": {"displayText":"origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque": {"displayText":"opaque origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"opaque origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-opaque"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site": {"displayText":"same site","export":true,"for_":["site"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-site-same-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site": {"displayText":"obtain a site","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"obtain a site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#obtain-a-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive": {"displayText":"parse a sandboxing directive","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"parse a sandboxing directive","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#parse-a-sandboxing-directive"},
"https://html.spec.whatwg.org/multipage/browsers.html#same-origin": {"displayText":"same origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#same-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#same-site": {"displayText":"same site","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"same site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#same-site"},
"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set": {"displayText":"sandboxing flag set","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"sandboxing flag set","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#sandboxing-flag-set"},
"https://html.spec.whatwg.org/multipage/browsers.html#site": {"displayText":"site","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"site","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#site"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching": {"displayText":"create navigation params by fetching","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"create navigation params by fetching","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-source-snapshot-params": {"displayText":"snapshotting source snapshot params","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"snapshotting source snapshot params","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#snapshotting-source-snapshot-params"},
"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params": {"displayText":"source snapshot params","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"source snapshot params","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsing-the-web.html#source-snapshot-params"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc": {"displayText":"browsing context","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active": {"displayText":"fully active","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"fully active","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document": {"displayText":"active document","export":true,"for_":["navigable"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"active document","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document"},
"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context": {"displayText":"top-level browsing context","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level browsing context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/document-sequences.html#top-level-browsing-context"},
"https://html.spec.whatwg.org/multipage/dom.html#concept-document-permissions-policy": {"displayText":"permissions policy","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"permissions policy","type":"dfn","url":"https://html.spec.whatwg.org/multipage/dom.html#concept-document-permissions-policy"},
"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie": {"displayText":"cookie","export":true,"for_":["Document"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"cookie","type":"attribute","url":"https://html.spec.whatwg.org/multipage/dom.html#dom-document-cookie"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use": {"displayText":"allowed to use","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"allowed to use","type":"dfn","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#allowed-to-use"},
"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element": {"displayText":"iframe","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"iframe","type":"element","url":"https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element"},
"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel": {"displayText":"in parallel","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"in parallel","type":"dfn","url":"https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"},
"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation": {"displayText":"consume user activation","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"consume user activation","type":"dfn","url":"https://html.spec.whatwg.org/multipage/interaction.html#consume-user-activation"},
"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation": {"displayText":"transient activation","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"transient activation","type":"dfn","url":"https://html.spec.whatwg.org/multipage/interaction.html#transient-activation"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#set-up-a-window-environment-settings-object": {"displayText":"set up a window environment settings object","export":true,"for_":[],"level":"","normative":true,"shortname":"html","spec":"html","status":"anchor-block","text":"set up a window environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#set-up-a-window-environment-settings-object"},
"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window": {"displayText":"Window","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"Window","type":"interface","url":"https://html.spec.whatwg.org/multipage/nav-history-apis.html#window"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id": {"displayText":"id","export":true,"for_":["environment"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"id","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin": {"displayText":"top-level origin","export":true,"for_":["environment"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"top-level origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-top-level-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global": {"displayText":"relevant global object","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant global object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"},
"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin": {"displayText":"origin","export":true,"for_":["environment settings object"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#concept-settings-object-origin"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": {"displayText":"environment settings object","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"},
"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source": {"displayText":"networking task source","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"networking task source","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#networking-task-source"},
"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task": {"displayText":"queue a global task","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"queue a global task","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-global-task"},
"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object": {"displayText":"relevant settings object","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"relevant settings object","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"},
"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context": {"displayText":"secure context","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"secure context","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context"},
"https://infra.spec.whatwg.org/#assert": {"displayText":"assert","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"assert","type":"dfn","url":"https://infra.spec.whatwg.org/#assert"},
"https://infra.spec.whatwg.org/#boolean": {"displayText":"boolean","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"boolean","type":"dfn","url":"https://infra.spec.whatwg.org/#boolean"},
"https://infra.spec.whatwg.org/#implementation-defined": {"displayText":"implementation-defined","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"implementation-defined","type":"dfn","url":"https://infra.spec.whatwg.org/#implementation-defined"},
"https://infra.spec.whatwg.org/#list-iterate": {"displayText":"iterate","export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"iterate","type":"dfn","url":"https://infra.spec.whatwg.org/#list-iterate"},
"https://infra.spec.whatwg.org/#string": {"displayText":"string","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://infra.spec.whatwg.org/#tuple": {"displayText":"tuple","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"tuple","type":"dfn","url":"https://infra.spec.whatwg.org/#tuple"},
"https://infra.spec.whatwg.org/#user-agent": {"displayText":"user agent","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"user agent","type":"dfn","url":"https://infra.spec.whatwg.org/#user-agent"},
"https://tools.ietf.org/html/rfc6265#section-5.3": {"displayText":"cookie store","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc6265","spec":"rfc6265","status":"anchor-block","text":"cookie store","type":"dfn","url":"https://tools.ietf.org/html/rfc6265#section-5.3"},
"https://url.spec.whatwg.org/#concept-url-origin": {"displayText":"origin","export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"origin","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-origin"},
"https://url.spec.whatwg.org/#concept-url-parser": {"displayText":"URL parser","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"url parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-parser"},
"https://w3c-fedid.github.io/FedCM/#browser-connected-accounts-set": {"displayText":"connected accounts set","export":true,"for_":[],"level":"","normative":true,"shortname":"fedcm","spec":"fedcm","status":"anchor-block","text":"connected accounts set","type":"dfn","url":"https://w3c-fedid.github.io/FedCM/#browser-connected-accounts-set"},
"https://w3c.github.io/permissions/#dfn-denied": {"displayText":"denied","export":true,"for_":["permission"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"denied","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-denied"},
"https://w3c.github.io/permissions/#dfn-getting-the-current-permission-state": {"displayText":"getting the current permission state","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"getting the current permission state","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-getting-the-current-permission-state"},
"https://w3c.github.io/permissions/#dfn-granted": {"displayText":"granted","export":true,"for_":["permission"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"granted","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-granted"},
"https://w3c.github.io/permissions/#dfn-name": {"displayText":"name","export":true,"for_":["powerful feature"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"name","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-name"},
"https://w3c.github.io/permissions/#dfn-permission-key": {"displayText":"permission key","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission key","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-key"},
"https://w3c.github.io/permissions/#dfn-permission-key-comparison-algorithm": {"displayText":"permission key comparison algorithm","export":true,"for_":["powerful feature"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission key comparison algorithm","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-key-comparison-algorithm"},
"https://w3c.github.io/permissions/#dfn-permission-key-generation-algorithm": {"displayText":"permission key generation algorithm","export":true,"for_":["powerful feature"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission key generation algorithm","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-key-generation-algorithm"},
"https://w3c.github.io/permissions/#dfn-permission-key-type": {"displayText":"permission key type","export":true,"for_":["powerful feature"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission key type","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-key-type"},
"https://w3c.github.io/permissions/#dfn-permission-query-algorithm": {"displayText":"permission query algorithm","export":true,"for_":["powerful feature"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission query algorithm","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-query-algorithm"},
"https://w3c.github.io/permissions/#dfn-permission-state": {"displayText":"permission state","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"permission state","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-permission-state"},
"https://w3c.github.io/permissions/#dfn-powerful-feature": {"displayText":"powerful feature","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"powerful feature","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-powerful-feature"},
"https://w3c.github.io/permissions/#dfn-prompt": {"displayText":"prompt","export":true,"for_":["permission"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"prompt","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-prompt"},
"https://w3c.github.io/permissions/#dfn-request-permission-to-use": {"displayText":"requesting permission to use","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"requesting permission to use","type":"dfn","url":"https://w3c.github.io/permissions/#dfn-request-permission-to-use"},
"https://w3c.github.io/permissions/#dom-permissiondescriptor": {"displayText":"PermissionDescriptor","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"PermissionDescriptor","type":"dictionary","url":"https://w3c.github.io/permissions/#dom-permissiondescriptor"},
"https://w3c.github.io/permissions/#dom-permissionstatus": {"displayText":"PermissionStatus","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"PermissionStatus","type":"interface","url":"https://w3c.github.io/permissions/#dom-permissionstatus"},
"https://w3c.github.io/permissions/#dom-permissionstatus-state": {"displayText":"state","export":true,"for_":["PermissionStatus"],"level":"1","normative":true,"shortname":"permissions","spec":"permissions","status":"current","text":"state","type":"attribute","url":"https://w3c.github.io/permissions/#dom-permissionstatus-state"},
"https://w3c.github.io/webappsec-credential-management/#concept-credential-store": {"displayText":"credential store","export":true,"for_":[],"level":"1","normative":true,"shortname":"credential-management","spec":"credential-management-1","status":"current","text":"credential store","type":"dfn","url":"https://w3c.github.io/webappsec-credential-management/#concept-credential-store"},
"https://w3c.github.io/webappsec-credential-management/#origin-prevent-silent-access-flag": {"displayText":"prevent silent access flag","export":true,"for_":[],"level":"1","normative":true,"shortname":"credential-management","spec":"credential-management-1","status":"anchor-block","text":"prevent silent access flag","type":"dfn","url":"https://w3c.github.io/webappsec-credential-management/#origin-prevent-silent-access-flag"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature": {"displayText":"policy-controlled feature","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"policy-controlled feature","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature"},
"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist": {"displayText":"default allowlist","export":true,"for_":["policy-controlled feature"],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"default allowlist","type":"dfn","url":"https://w3c.github.io/webappsec-permissions-policy/#policy-controlled-feature-default-allowlist"},
"https://w3c.github.io/webappsec-permissions-policy/#should-request-be-allowed-to-use-feature": {"displayText":"Should request be allowed to use feature?","export":true,"for_":[],"level":"1","normative":true,"shortname":"permissions-policy","spec":"permissions-policy-1","status":"current","text":"Should request be allowed to use feature?","type":"abstract-op","url":"https://w3c.github.io/webappsec-permissions-policy/#should-request-be-allowed-to-use-feature"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context": {"displayText":"current browsing context","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"current browsing context","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-current-browsing-context"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error": {"displayText":"WebDriver error","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"webdriver error","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code": {"displayText":"WebDriver error code","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"webdriver error code","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-error-code"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands": {"displayText":"extension command","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"extension command","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-extension-commands"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties": {"displayText":"getting a property","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"getting a property","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-getting-properties"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument": {"displayText":"invalid argument","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"invalid argument","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-invalid-argument"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps": {"displayText":"remote end steps","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"remote end steps","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-remote-end-steps"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success": {"displayText":"success","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"success","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-success"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error": {"displayText":"unknown error","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"unknown error","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unknown-error"},
"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation": {"displayText":"unsupported operation","export":true,"for_":[],"level":"","normative":true,"shortname":"webdriver","spec":"webdriver","status":"anchor-block","text":"unsupported operation","type":"dfn","url":"https://w3c.github.io/webdriver/webdriver-spec.html#dfn-unsupported-operation"},
"https://webidl.spec.whatwg.org/#a-new-promise": {"displayText":"a new promise","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"a new promise","type":"dfn","url":"https://webidl.spec.whatwg.org/#a-new-promise"},
"https://webidl.spec.whatwg.org/#idl-DOMException": {"displayText":"DOMException","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMException","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMException"},
"https://webidl.spec.whatwg.org/#idl-boolean": {"displayText":"boolean","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"boolean","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-boolean"},
"https://webidl.spec.whatwg.org/#idl-promise": {"displayText":"Promise","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"Promise","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-promise"},
"https://webidl.spec.whatwg.org/#idl-undefined": {"displayText":"undefined","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"undefined","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-undefined"},
"https://webidl.spec.whatwg.org/#invalidstateerror": {"displayText":"InvalidStateError","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"InvalidStateError","type":"exception","url":"https://webidl.spec.whatwg.org/#invalidstateerror"},
"https://webidl.spec.whatwg.org/#notallowederror": {"displayText":"NotAllowedError","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"NotAllowedError","type":"exception","url":"https://webidl.spec.whatwg.org/#notallowederror"},
"https://webidl.spec.whatwg.org/#reject": {"displayText":"reject","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"reject","type":"dfn","url":"https://webidl.spec.whatwg.org/#reject"},
"https://webidl.spec.whatwg.org/#resolve": {"displayText":"resolve","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"resolve","type":"dfn","url":"https://webidl.spec.whatwg.org/#resolve"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>